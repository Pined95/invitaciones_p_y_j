<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Env√≠os P&J</title>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Cinzel:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --gold: #C59D5F; --dark: #1a1a1a; --cream: #FDFBF7; 
            --whatsapp: #25D366; --white: #ffffff;
            --success: #2e7d32; --error: #c62828; --pending: #f57c00;
            --sent-bg: #e8f5e9; --sent-border: #4caf50;
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: var(--cream); margin: 0; display: flex; height: 100vh; color: var(--dark); overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { 
            width: 400px; background: var(--white); border-right: 1px solid #ccc; 
            padding: 20px; display: flex; flex-direction: column; gap: 15px; 
            box-shadow: 4px 0 20px rgba(0,0,0,0.1); z-index: 10; overflow-y: auto; flex-shrink: 0;
        }
        
        h2 { font-family: 'Cinzel', serif; color: var(--gold); margin: 0; font-size: 1.4rem; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* TABS */
        .tabs { display: flex; gap: 5px; background: #f0f0f0; padding: 4px; border-radius: 8px; }
        .tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 0.7rem; font-weight: bold; color: #666; transition: 0.2s; }
        .tab.active { background: white; color: var(--gold); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .template-container { display: none; }
        .template-container.active { display: block; animation: fadeIn 0.3s; }

        label { font-size: 0.7rem; font-weight: bold; color: #999; text-transform: uppercase; display: block; margin-bottom: 5px; }
        
        textarea { 
            width: 100%; height: 150px; padding: 12px; border: 1px solid #ccc; 
            border-radius: 8px; font-family: inherit; resize: none; font-size: 0.85rem; 
            background: #fafafa; transition: 0.3s; line-height: 1.5;
        }
        textarea:focus { border-color: var(--gold); background: white; outline: none; }
        
        .tags { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
        .tag { background: var(--dark); color: var(--gold); padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 20px 40px; overflow-y: auto; background-image: radial-gradient(#dcdcdc 1px, transparent 1px); background-size: 20px 20px; }
        
        .top-filters { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-bar { flex: 1; padding: 12px; border: 1px solid var(--gold); border-radius: 8px; font-family: inherit; font-size: 1rem; background: white; }
        .filter-select { padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: white; cursor: pointer; font-family: inherit; }

        /* CARDS */
        .card { 
            background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #ccc; 
            display: flex; flex-direction: column; gap: 10px; transition: 0.3s;
        }
        .card.sent { border-left-color: var(--sent-border); background: var(--sent-bg); }
        .card.needs-reminder { border-left-color: var(--pending); background: #fff8e1; }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .card-title h3 { margin: 0; font-family: 'Cinzel', serif; font-size: 1.1rem; color: var(--dark); }
        .card-subtitle { font-size: 0.8rem; color: #666; font-style: italic; margin-top: 4px; }
        
        /* BADGES */
        .status-badge { font-size: 0.65rem; padding: 3px 8px; border-radius: 4px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .badge-fresh { color: var(--success); background: #c8e6c9; }
        .badge-stale { color: #e65100; background: #ffe0b2; border: 1px solid #ffcc80; }
        .badge-type { background: #eee; color: #666; text-transform: uppercase; }

        /* FOOTER & BUTTONS */
        .card-footer { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd; 
        }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

        /* Botones de WhatsApp Individuales */
        .btn-wa-mini {
            background: white; border: 1px solid var(--whatsapp); color: var(--whatsapp);
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer;
            font-weight: 600; display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .btn-wa-mini:hover { background: var(--whatsapp); color: white; transform: translateY(-2px); }
        
        /* Estilo Recordatorio */
        .btn-wa-mini.reminder { border-color: var(--pending); color: var(--pending); }
        .btn-wa-mini.reminder:hover { background: var(--pending); color: white; }

        .btn-no-tel { background: #f5f5f5; color: #999; border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: not-allowed; }

        /* Check Manual */
        .btn-check { 
            width: 35px; height: 35px; border-radius: 50%; border: 1px solid #ccc; 
            background: white; color: #ccc; cursor: pointer; display: flex; 
            justify-content: center; align-items: center; transition: 0.2s; font-size: 1rem;
        }
        .btn-check:hover { border-color: var(--gold); color: var(--gold); }
        .card.sent .btn-check { background: var(--sent-border); color: white; border-color: var(--sent-border); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Centro de Env√≠os</h2>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('plural')">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Grupal</div>
            <div class="tab" onclick="switchTab('singular')">üë§ Individual</div>
            <div class="tab" onclick="switchTab('recordatorio')">‚è∞ Recordatorio</div>
        </div>

        <div id="tpl-plural" class="template-container active">
            <label>Mensaje Grupal (Familia)</label>
            <textarea id="msg-plural">¬°Hola Familia {nombre}! üëã

Nos llena de emoci√≥n invitarlos a nuestra boda. Ser√° un d√≠a muy especial y queremos compartirlo con ustedes. üë∞ü§µ

Aqu√≠ les dejamos su invitaci√≥n digital y pases de acceso:
{link}

¬°Esperamos contar con su presencia!</textarea>
            <div class="tags"><span class="tag" onclick="insertTag('msg-plural', '{nombre}')">+ Nombre</span><span class="tag" onclick="insertTag('msg-plural', '{link}')">+ Link</span></div>
        </div>

        <div id="tpl-singular" class="template-container">
            <label>Mensaje Individual</label>
            <textarea id="msg-singular">¬°Hola {nombre}! üëã

Me llena de emoci√≥n invitarte a nuestra boda. Ser√° un d√≠a muy especial y quiero compartirlo contigo. üë∞ü§µ

Aqu√≠ te dejo tu invitaci√≥n digital y pase de acceso:
{link}

¬°Espero contar contigo!</textarea>
            <div class="tags"><span class="tag" onclick="insertTag('msg-singular', '{nombre}')">+ Nombre</span><span class="tag" onclick="insertTag('msg-singular', '{link}')">+ Link</span></div>
        </div>

        <div id="tpl-recordatorio" class="template-container">
            <label>Recordatorio</label>
            <textarea id="msg-recordatorio">¬°Hola {nombre}! ‚ú®

Solo paso a recordarles que nuestra boda est√° cerca y nos encantar√≠a saber si podr√°n acompa√±arnos para organizar sus lugares.

Pueden confirmar aqu√≠: {link}

¬°Un abrazo!</textarea>
            <div class="tags"><span class="tag" onclick="insertTag('msg-recordatorio', '{nombre}')">+ Nombre</span><span class="tag" onclick="insertTag('msg-recordatorio', '{link}')">+ Link</span></div>
        </div>

        <div style="margin-top:auto; background:#f9f9f9; padding:15px; border-radius:8px; font-size:0.8rem;">
            <div style="margin-bottom:5px;"><strong>üìä Resumen:</strong></div>
            <div style="display:flex; justify-content:space-between;"><span>Total:</span> <strong id="st-total">0</strong></div>
            <div style="display:flex; justify-content:space-between;"><span>Enviados:</span> <strong id="st-sent" style="color:var(--success)">0</strong></div>
            <button onclick="resetSentHistory()" style="width:100%; margin-top:10px; border:none; background:white; border:1px solid #ddd; padding:5px; cursor:pointer; font-size:0.7rem; color:red;">Borrar Historial</button>
        </div>
    </div>

    <div class="main-content">
        <div class="top-filters">
            <input type="text" class="search-bar" id="search" placeholder="üîç Buscar invitado, tel√©fono..." onkeyup="renderList()">
            <select class="filter-select" id="filter-type" onchange="renderList()">
                <option value="all">Todos</option>
                <option value="pending">Sin Enviar</option>
                <option value="sent">Ya Enviados</option>
                <option value="reminder">Requiere Recordatorio</option>
            </select>
        </div>
        <div id="cards-container">
            <p style="text-align:center; color:#999; margin-top:50px;"><i class="fa-solid fa-circle-notch fa-spin"></i> Cargando...</p>
        </div>
    </div>

<script>
    // --- API URL ---
    const API_URL = "https://script.google.com/macros/s/AKfycbyKWw1ST_THRFt9joUGpKDLVxM1goT_PxZ6nmXw1-9luzRPi7JX_MZmQ5k4GY2dVUw/exec"; 
    
    let groups = [];
    // Diccionario: { "ID_GRUPO": timestamp_envio }
    let sentLog = JSON.parse(localStorage.getItem('pj_sent_timestamps_final') || '{}');

    window.onload = async () => {
        // Cargar plantillas de memoria si existen
        ['plural', 'singular', 'recordatorio'].forEach(t => {
            if(localStorage.getItem(`pj_tpl_${t}`)) document.getElementById(`msg-${t}`).value = localStorage.getItem(`pj_tpl_${t}`);
            document.getElementById(`msg-${t}`).addEventListener('input', (e) => localStorage.setItem(`pj_tpl_${t}`, e.target.value));
        });

        try {
            const res = await fetch(`${API_URL}?action=getSendList`); 
            const data = await res.json();
            if(data.status === 'success') {
                processData(data.guests);
                renderList();
                updateStats();
            }
        } catch(e) { 
            console.error(e);
            document.getElementById('cards-container').innerHTML = '<p style="text-align:center; color:red;">Error de conexi√≥n</p>';
        }
    };

    function switchTab(type) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.template-container').forEach(c => c.classList.remove('active'));
        
        const idx = type === 'plural' ? 0 : (type === 'singular' ? 1 : 2);
        document.querySelectorAll('.tab')[idx].classList.add('active');
        document.getElementById(`tpl-${type}`).classList.add('active');
    }

    function processData(guests) {
        const grouped = {};
        
        guests.forEach(g => {
            const gid = g.groupId || g.id;
            
            if(!grouped[gid]) {
                grouped[gid] = {
                    id: gid,
                    mainName: g.nombreGrupo || g.nombre,
                    link: g.link,
                    members: [],
                    phones: [], // Array de objetos {name, number}
                    isPlural: false
                };
            }
            
            grouped[gid].members.push(g.nombre);

            // LOGICA ROBUSTA DE TEL√âFONO
            // Limpia todo lo que no sea n√∫mero
            let rawPhone = String(g.telefono || "").replace(/\D/g, "");
            
            // Si tiene longitud v√°lida, lo agregamos
            if (rawPhone.length >= 10) {
                // Verificamos si ya existe este n√∫mero en el grupo para no duplicar bot√≥n
                const exists = grouped[gid].phones.find(p => p.number === rawPhone);
                if (!exists) {
                    grouped[gid].phones.push({
                        name: g.nombre.split(' ')[0], // Nombre corto para el bot√≥n
                        number: rawPhone
                    });
                }
            }
        });

        // Detectar Plural
        Object.values(grouped).forEach(g => {
            const nameLower = g.mainName.toLowerCase();
            if(g.members.length > 1 || nameLower.includes('fam') || nameLower.includes(' y ') || nameLower.includes('&')) {
                g.isPlural = true;
            }
        });

        groups = Object.values(grouped);
    }

    function renderList() {
        const term = document.getElementById('search').value.toLowerCase();
        const filter = document.getElementById('filter-type').value;
        const container = document.getElementById('cards-container');
        container.innerHTML = '';
        
        let visibleCount = 0;

        groups.forEach(g => {
            // L√≥gica de Tiempos
            const lastSent = sentLog[g.id] || 0;
            const isSent = lastSent > 0;
            const daysSince = isSent ? Math.floor((Date.now() - lastSent) / (1000 * 60 * 60 * 24)) : 0;
            const needsReminder = isSent && daysSince >= 3;

            // Filtros de Vista
            if(filter === 'pending' && isSent) return;
            if(filter === 'sent' && !isSent) return;
            if(filter === 'reminder' && !needsReminder) return;

            // Filtro de Texto (Busca en nombre grupo, miembros o tel√©fonos)
            const textMatch = g.mainName.toLowerCase().includes(term) || 
                              g.members.some(m => m.toLowerCase().includes(term)) ||
                              g.phones.some(p => p.number.includes(term));

            if(textMatch) {
                visibleCount++;
                
                // 1. Elegir Plantilla
                let msgType = g.isPlural ? 'plural' : 'singular';
                if(needsReminder) msgType = 'recordatorio';

                let rawMsg = document.getElementById(`msg-${msgType}`).value;
                
                // 2. Limpieza de Nombre
                let cleanName = g.mainName;
                if(g.isPlural && rawMsg.includes('Familia {nombre}')) cleanName = cleanName.replace(/^Familia\s+/i, ''); 

                // 3. Reemplazar y Codificar
                rawMsg = rawMsg.replace(/{nombre}/g, cleanName).replace(/{link}/g, g.link);
                const encodedMsg = encodeURIComponent(rawMsg);

                // 4. Generar Botones de WhatsApp
                let buttonsHtml = '';
                if (g.phones.length === 0) {
                    buttonsHtml = `<span class="btn-no-tel"><i class="fa-solid fa-ban"></i> Sin tel√©fono</span>`;
                } else {
                    g.phones.forEach(p => {
                        const url = `https://api.whatsapp.com/send?phone=${p.number}&text=${encodedMsg}`;
                        // Si toca recordatorio, cambiamos el estilo del bot√≥n
                        const btnClass = needsReminder ? 'btn-wa-mini reminder' : 'btn-wa-mini';
                        const icon = needsReminder ? 'fa-solid fa-bell' : 'fa-brands fa-whatsapp';
                        
                        buttonsHtml += `
                            <button class="${btnClass}" onclick="sendWA('${g.id}', '${url}')">
                                <i class="${icon}"></i> ${p.name}
                            </button>`;
                    });
                }

                // 5. Etiqueta de Estado
                let statusLabel = `<span class="badge-type status-badge">${g.isPlural?'Grupal':'Individual'}</span>`;
                let cardClass = 'card';
                
                if(isSent) {
                    cardClass += ' sent';
                    if(needsReminder) {
                        cardClass += ' needs-reminder';
                        statusLabel = `<div class="status-badge badge-stale"><i class="fa-solid fa-triangle-exclamation"></i> Hace ${daysSince} d√≠as</div>`;
                    } else {
                        statusLabel = `<div class="status-badge badge-fresh"><i class="fa-solid fa-check"></i> Enviado hoy</div>`;
                    }
                }

                const html = `
                    <div class="${cardClass}" id="card-${g.id}">
                        <div class="card-header">
                            <div class="card-title">
                                <h3>${g.mainName}</h3>
                                <div class="card-subtitle">${g.members.join(', ')}</div>
                            </div>
                            ${statusLabel}
                        </div>
                        <div class="card-footer">
                            <div class="btn-group">${buttonsHtml}</div>
                            <button class="btn-check" onclick="toggleSent('${g.id}')" title="Marcar/Desmarcar">
                                <i class="fa-solid fa-check"></i>
                            </button>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            }
        });

        if(visibleCount === 0) container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">No se encontraron resultados.</div>';
    }

    // --- ACCIONES ---

    function sendWA(id, url) {
        window.open(url, '_blank');
        // Auto-marcar como enviado (guarda fecha)
        sentLog[id] = Date.now();
        saveLog();
        setTimeout(() => { renderList(); updateStats(); }, 1500);
    }

    function toggleSent(id) {
        if(sentLog[id]) delete sentLog[id];
        else sentLog[id] = Date.now();
        saveLog();
        renderList();
        updateStats();
    }

    function saveLog() { localStorage.setItem('pj_sent_timestamps_final', JSON.stringify(sentLog)); }

    function insertTag(areaId, tag) {
        const area = document.getElementById(areaId);
        area.setRangeText(tag, area.selectionStart, area.selectionEnd, 'end');
        area.dispatchEvent(new Event('input'));
        area.focus();
    }

    function resetSentHistory() {
        if(confirm("¬øBorrar historial de env√≠os? Se perder√°n las fechas.")) {
            sentLog = {};
            saveLog();
            renderList();
            updateStats();
        }
    }

    function updateStats() {
        document.getElementById('st-total').innerText = groups.length;
        document.getElementById('st-sent').innerText = Object.keys(sentLog).length;
    }
</script>
</body>
</html>