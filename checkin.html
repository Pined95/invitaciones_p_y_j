<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Check-in | P&J</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* VARIABLES DE DISE√ëO (Congruencia Visual) */
        :root { 
            --gold: #C59D5F; 
            --dark: #1a1a1a; 
            --cream: #FDFBF7; 
            --success: #2e7d32; 
            --error: #c62828; 
            --warning: #f57c00; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Montserrat', sans-serif; 
            background: var(--dark); 
            color: var(--cream); 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* BARRA SUPERIOR */
        .top-bar { 
            background: #000; 
            padding: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid var(--gold); 
            z-index: 10;
        }
        .logo { font-family: 'Cinzel', serif; color: var(--gold); font-size: 1.2rem; margin: 0; }
        .sync-status { font-size: 0.75rem; color: #888; display: flex; align-items: center; gap: 5px; }
        .sync-status.online { color: var(--success); }
        .sync-status.offline { color: var(--error); animation: pulse 2s infinite; }

        /* C√ÅMARA / ESC√ÅNER */
        .scanner-wrapper { 
            flex: 1; 
            position: relative; 
            background: #000; 
            overflow: hidden; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        
        /* GUIAS VISUALES DE ESCANEO */
        .scan-overlay { 
            position: absolute; width: 260px; height: 260px; 
            border: 2px solid rgba(197, 157, 95, 0.5); 
            border-radius: 20px; 
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.7); 
            pointer-events: none;
        }
        .scan-overlay::after {
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            border: 3px solid var(--gold); border-radius: 20px;
            clip-path: polygon(0% 20%, 0% 0%, 20% 0%, 80% 0%, 100% 0%, 100% 20%, 100% 80%, 100% 100%, 80% 100%, 20% 100%, 0% 100%, 0% 80%);
        }

        /* CONTROLES INFERIORES */
        .controls { 
            background: var(--cream); 
            color: var(--dark); 
            padding: 20px; 
            border-radius: 20px 20px 0 0; 
            z-index: 20; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        
        .stats-row { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .stat-box { text-align: center; }
        .stat-num { display: block; font-size: 1.5rem; font-weight: 700; color: var(--gold); font-family: 'Cinzel', serif; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #666; }

        .btn-group { display: flex; gap: 10px; }
        .btn { 
            flex: 1; padding: 15px; border: none; border-radius: 8px; 
            font-weight: bold; font-size: 0.9rem; cursor: pointer; 
            display: flex; justify-content: center; align-items: center; gap: 8px; 
            transition: 0.2s; 
        }
        .btn-primary { background: var(--gold); color: white; }
        .btn-primary:active { transform: scale(0.98); background: #b08d55; }
        .btn-secondary { background: #e0e0e0; color: var(--dark); }

        /* MODAL DE RESULTADOS */
        .result-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.92); z-index: 100; 
            display: none; flex-direction: column; justify-content: center; align-items: center; 
            padding: 20px; text-align: center; 
        }
        .result-card { 
            background: white; width: 100%; max-width: 350px; 
            border-radius: 15px; padding: 40px 20px; 
            border-top: 8px solid #ccc; color: var(--dark); 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .status-icon { font-size: 4rem; margin-bottom: 15px; }
        .guest-name { font-family: 'Cinzel', serif; font-size: 1.5rem; margin: 10px 0; line-height: 1.2; }
        .guest-table { font-size: 1.2rem; color: var(--gold); font-weight: bold; margin-bottom: 5px; display: block;}
        .guest-info { font-size: 0.85rem; color: #666; margin-bottom: 25px; background: #f5f5f5; padding: 10px; border-radius: 8px; }

        /* Variantes de Modal */
        .res-success .result-card { border-top-color: var(--success); } 
        .res-success .status-icon { color: var(--success); }
        
        .res-error .result-card { border-top-color: var(--error); } 
        .res-error .status-icon { color: var(--error); }
        
        .res-warning .result-card { border-top-color: var(--warning); } 
        .res-warning .status-icon { color: var(--warning); }

        /* MODAL MANUAL */
        #manual-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--cream); color:var(--dark); z-index:50; display:none; flex-direction:column; padding:20px; }
        .manual-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .search-input { padding: 15px; border: 1px solid var(--gold); width: 100%; border-radius: 8px; font-size: 1rem; font-family: inherit; margin-bottom: 15px; }
        .manual-list { flex: 1; overflow-y: auto; border-top: 1px solid #eee; }
        .manual-item { 
            background: white; padding: 15px; border-bottom: 1px solid #f0f0f0; 
            display: flex; justify-content: space-between; align-items: center; cursor: pointer; 
        }
        .manual-item.checked { background: #e8f5e9; opacity: 0.7; }
        .manual-item strong { display: block; font-size: 0.95rem; }
        .manual-item small { color: #888; }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="logo">Check-in</div>
        <div class="sync-status" id="sync-status"><i class="fa-solid fa-circle-notch fa-spin"></i> Cargando...</div>
    </div>
    
    <div class="scanner-wrapper">
        <div id="reader"></div>
        <div class="scan-overlay"></div>
    </div>
    
    <div class="controls">
        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-num" id="stat-in">0</span>
                <span class="stat-label">Ingresados</span>
            </div>
            <div class="stat-box">
                <span class="stat-num" id="stat-total">0</span>
                <span class="stat-label">Total Lista</span>
            </div>
            <div class="stat-box">
                <span class="stat-num" id="stat-queue" style="color:var(--warning)">0</span>
                <span class="stat-label">Cola Offline</span>
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-primary" onclick="startCamera()"><i class="fa-solid fa-qrcode"></i> ESCANEAR</button>
            <button class="btn btn-secondary" onclick="openManual()"><i class="fa-solid fa-magnifying-glass"></i> BUSCAR</button>
        </div>
    </div>

    <div id="result-modal" class="result-modal">
        <div class="result-card">
            <i class="fa-solid fa-circle-check status-icon" id="res-icon"></i>
            <h2 class="guest-name" id="res-name">Nombre Invitado</h2>
            <span class="guest-table" id="res-table">MESA 1</span>
            <div class="guest-info" id="res-info">Detalles...</div>
            <button class="btn btn-dark" style="background:var(--dark); color:white;" onclick="closeResult()">ACEPTAR & CONTINUAR</button>
        </div>
    </div>

    <div id="manual-modal">
        <div class="manual-header">
            <h2 style="margin:0; font-family:'Cinzel'; color:var(--gold);">B√∫squeda Manual</h2>
            <button onclick="document.getElementById('manual-modal').style.display='none'" style="border:none; background:none; font-size:1.5rem;">&times;</button>
        </div>
        <input type="text" class="search-input" id="search-box" placeholder="Escribe el apellido..." onkeyup="filterManual()">
        <div class="manual-list" id="manual-list"></div>
    </div>

    <audio id="beep-ok" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.m3u8"></audio>
    <audio id="beep-err" src="https://assets.mixkit.co/active_storage/sfx/950/950-preview.m3u8"></audio>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    // --- PEGAR TU URL DE APPS SCRIPT AQU√ç ---
    const API_URL = "https://script.google.com/macros/s/AKfycbyKWw1ST_THRFt9joUGpKDLVxM1goT_PxZ6nmXw1-9luzRPi7JX_MZmQ5k4GY2dVUw/exec"; 
    
    // Contrase√±a codificada (PYJ310524)
    const PASS_HASH = "UFlKMzEwNTI0"; 
    
    let guestList = [];     // Base de datos local
    let offlineQueue = [];  // Cola de IDs escaneados sin internet
    let scanner = null;
    let isProcessing = false;

    // --- INICIALIZACI√ìN ---
    window.onload = async () => {
        // 1. Auth Simple
        if(!localStorage.getItem('pj_chk_auth')) {
            const pass = prompt("üîê Contrase√±a de Recepci√≥n:");
            if(btoa(pass) !== PASS_HASH) { 
                document.body.innerHTML="<div style='color:white;text-align:center;margin-top:50px'>‚õî Acceso Denegado</div>"; 
                return; 
            }
            localStorage.setItem('pj_chk_auth', 'true');
        }

        // 2. Cargar datos locales
        loadLocal();
        
        // 3. Sincronizar primera vez
        await sync();

        // 4. Iniciar c√°mara
        startCamera();

        // 5. Ciclos autom√°ticos
        setInterval(sync, 60000);       // Bajar datos cada minuto
        setInterval(flushQueue, 15000); // Subir cola cada 15 seg
    };

    // --- GESTI√ìN DE DATOS ---
    function loadLocal() {
        if(localStorage.getItem('pj_db')) guestList = JSON.parse(localStorage.getItem('pj_db'));
        if(localStorage.getItem('pj_q')) offlineQueue = JSON.parse(localStorage.getItem('pj_q'));
        updateStats();
    }

    async function sync() {
        const statusEl = document.getElementById('sync-status');
        statusEl.innerHTML = '<i class="fa-solid fa-rotate fa-spin"></i> Sync...';
        
        try {
            const res = await fetch(`${API_URL}?action=getAllGuestsForCheckin`);
            const data = await res.json();
            
            if(data.status === 'success') {
                // Actualizamos la lista local, pero preservamos los check-ins offline que aun no se suben
                guestList = data.guests; 
                localStorage.setItem('pj_db', JSON.stringify(guestList));
                
                statusEl.innerHTML = '<i class="fa-solid fa-wifi"></i> Online';
                statusEl.className = 'sync-status online';
                updateStats();
            }
        } catch(e) { 
            statusEl.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Offline';
            statusEl.className = 'sync-status offline';
        }
    }

    // --- C√ÅMARA ---
    function startCamera() {
        if(scanner) return; // Ya est√° corriendo
        
        scanner = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        scanner.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => {
            console.error(err);
            alert("No se pudo iniciar la c√°mara. Usa la b√∫squeda manual.");
        });
    }

    function onScanSuccess(decodedText) {
        if(isProcessing) return; // Evitar doble lectura
        isProcessing = true;
        scanner.pause(); // Congelar c√°mara
        
        const id = decodedText.trim();
        processCheckin(id);
    }

    // --- L√ìGICA DE CHECK-IN ---
    function processCheckin(id) {
        const guest = guestList.find(g => g.id === id);
        
        // 1. Error: No existe
        if(!guest) { 
            showModal('error', 'Desconocido', '', 'El c√≥digo QR no pertenece a la lista.'); 
            play('err'); 
            return; 
        }
        
        // 2. Warning: Ya entr√≥
        // (Verificamos si tiene fecha en DB o si est√° en nuestra cola local)
        if(guest.checkinTime || offlineQueue.includes(id)) {
            showModal('warning', guest.nombre, guest.mesa || "Sin Mesa", '‚ö†Ô∏è Este invitado ya fue registrado previamente.'); 
            play('err');
        } 
        // 3. √âxito: Registrar
        else {
            // Marcamos localmente
            guest.checkinTime = new Date().toISOString();
            
            // Agregamos a la cola para subir
            if(!offlineQueue.includes(id)) {
                offlineQueue.push(id);
                localStorage.setItem('pj_q', JSON.stringify(offlineQueue));
            }
            
            showModal('success', guest.nombre, guest.mesa ? "MESA " + guest.mesa : "Sin Asignar", '‚úÖ Acceso Autorizado');
            play('ok');
            updateStats();
        }
    }

    // --- COLA OFFLINE ---
    async function flushQueue() {
        if(offlineQueue.length === 0 || !navigator.onLine) return;

        try {
            // Enviamos el lote al servidor
            await fetch(API_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ action: 'BATCH_CHECKIN', ids: offlineQueue }) 
            });
            
            // Limpiamos cola solo si no hubo error de red (asumimos √©xito con no-cors)
            offlineQueue = [];
            localStorage.setItem('pj_q', '[]');
            
            // Forzamos sync para traer la hora real del servidor
            sync();
            updateStats();
            
        } catch(e) {
            console.log("Fallo al subir cola, reintentando luego...");
        }
    }

    // --- INTERFAZ ---
    function showModal(type, name, table, info) {
        const m = document.getElementById('result-modal');
        m.className = `result-modal res-${type}`;
        m.style.display = 'flex';
        
        // Icono
        const icon = document.getElementById('res-icon');
        if(type==='success') icon.className="fa-solid fa-circle-check status-icon";
        else if(type==='warning') icon.className="fa-solid fa-triangle-exclamation status-icon";
        else icon.className="fa-solid fa-circle-xmark status-icon";

        document.getElementById('res-name').innerText = name;
        document.getElementById('res-table').innerText = table;
        document.getElementById('res-info').innerText = info;
    }

    function closeResult() {
        document.getElementById('result-modal').style.display = 'none';
        isProcessing = false;
        if(scanner) scanner.resume(); // Reactivar c√°mara
    }

    function updateStats() {
        document.getElementById('stat-total').innerText = guestList.length;
        // Contamos los que tienen checkinTime (server) O est√°n en cola (local)
        const count = guestList.filter(g => g.checkinTime || offlineQueue.includes(g.id)).length;
        document.getElementById('stat-in').innerText = count;
        document.getElementById('stat-queue').innerText = offlineQueue.length;
    }

    function play(type) {
        const audio = document.getElementById(type==='ok'?'beep-ok':'beep-err');
        if(audio) { audio.currentTime=0; audio.play().catch(e=>{}); }
    }

    // --- B√öSQUEDA MANUAL ---
    function openManual() {
        if(scanner) scanner.pause(); // Pausar para ahorrar bater√≠a
        document.getElementById('manual-modal').style.display = 'flex';
        document.getElementById('search-box').value = '';
        filterManual(); // Mostrar todos o vacio
    }

    function filterManual() {
        const q = document.getElementById('search-box').value.toLowerCase();
        const list = document.getElementById('manual-list');
        list.innerHTML = '';
        
        // Filtrar
        const matches = guestList.filter(g => g.nombre.toLowerCase().includes(q));
        
        matches.forEach(g => {
            const isChecked = g.checkinTime || offlineQueue.includes(g.id);
            list.innerHTML += `
                <div class="manual-item ${isChecked?'checked':''}" onclick="manualSelect('${g.id}')">
                    <div>
                        <strong>${g.nombre}</strong>
                        <small>${g.mesa || 'Sin Mesa'}</small>
                    </div>
                    ${isChecked ? '<i class="fa-solid fa-check" style="color:var(--success)"></i>' : '<i class="fa-solid fa-chevron-right" style="color:#ccc"></i>'}
                </div>`;
        });
    }

    function manualSelect(id) {
        document.getElementById('manual-modal').style.display = 'none';
        processCheckin(id);
    }
</script>
</body>
</html>