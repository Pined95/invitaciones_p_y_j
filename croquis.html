<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Planner P&J</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"></noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js" defer></script>

    <style>
        :root {
            --novio: #2196f3; --novia: #e91e63;
            --nino: #ffc107; --adolescente: #9c27b0;
            --joven: #ff5722; --adulto: #607d8b;
            --vegano: #4caf50;
            --salon-border: #333;
        }
        body { font-family: 'Montserrat', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; background: #e0e0e0; overscroll-behavior: none; }
        
        /* SIDEBAR */
        #sidebar { width: 340px; background: white; border-right: 1px solid #999; display: flex; flex-direction: column; z-index: 20; box-shadow: 2px 0 15px rgba(0,0,0,0.2); }
        .sidebar-header { padding: 15px; background: #1a1a1a; color: #C59D5F; text-align: center; }
        .search-box { padding: 10px; background: #f4f4f4; border-bottom: 1px solid #ddd; display: flex; gap:5px;}
        .search-box input { flex:1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #guest-pool { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; }

        /* CHIPS */
        .guest-chip { background: white; padding: 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #ccc; cursor: grab; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; border-left-width: 5px; transition: all 0.2s; position: relative; }
        .guest-chip:hover { transform: translateX(5px); box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .guest-chip.assigned { opacity: 0.5; background: #e0e0e0; color: #888; filter: grayscale(1); pointer-events: none; } /* Deshabilitado si ya tiene mesa */
        
        .type-nino { border-left-color: var(--nino); background: #fffde7; }
        .type-adolescente { border-left-color: var(--adolescente); }
        .type-joven { border-left-color: var(--joven); }
        .type-adulto { border-left-color: var(--adulto); }

        .family-tag { font-size: 0.65rem; color: #888; display: block; margin-top: 2px;}
        .icon-container { display: flex; gap: 3px; font-size: 0.9rem; }

        /* CANVAS */
        #canvas-area { flex: 1; position: relative; overflow: auto; background-image: radial-gradient(#aaa 1px, transparent 1px); background-size: 20px 20px; touch-action: none; user-select: none; }
        #canvas-content { position: relative; width: 3000px; height: 2000px; transform-origin: 0 0; transition: transform 0.1s ease-out; }
        #salon-border { position: absolute; border: 4px solid var(--salon-border); background: rgba(255,255,255,0.05); pointer-events: stroke; cursor: move; }
        
        /* ZOOM CONTROLS */
        .zoom-controls { position: absolute; bottom: 20px; right: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 150; display: flex; flex-direction: column; }
        .zoom-btn { width: 40px; height: 40px; border: none; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; border-bottom: 1px solid #eee; }
        .zoom-btn:last-child { border-bottom: none; }
        .zoom-btn:hover { background: #f0f0f0; }
        .zoom-level { padding: 8px; text-align: center; font-size: 0.75rem; color: #666; border-top: 1px solid #eee; }

        /* OBJETOS MAPA */
        .map-obj { position: absolute; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.15); cursor: grab; touch-action: none; border: 3px solid white; font-weight: bold; font-size: 0.8rem; color: #333; transition: border-color 0.3s, box-shadow 0.2s; }
        
        /* Estilos Base de Formas */
        .shape-round { border-radius: 50%; }
        .shape-square { border-radius: 4px; }
        .shape-rect { border-radius: 4px; }

        .fixed-obj { color: white; z-index: 5; border: none !important; }
        .obj-novios { background: #C59D5F; border-radius: 30px; }
        .obj-dj { background: #333; border: 2px solid gold; border-radius: 4px; }
        .obj-dance { background: rgba(0,0,0,0.1); border: 2px dashed #666; z-index: 1; color: #666; }
        .obj-wc { background: #009688; border-radius: 8px; }
        .obj-exit { background: #4caf50; }

        .table-alert { position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; background: red; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; animation: pulse 1.5s infinite; display: none; z-index: 15; cursor: help; font-size: 1rem; }
        .map-obj.drag-hover { border-color: #C59D5F; transform: scale(1.05); z-index: 100; }
        .map-obj.table-full { background-color: #ffebee; }
        
        .vegan-indicator { position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); background: #4caf50; color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 10px; display: none; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .alert-tooltip { position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 8px; border-radius: 6px; font-size: 0.7rem; width: 180px; display: none; z-index: 20; pointer-events: none; text-align: left; }
        .table-alert:hover .alert-tooltip { display: block; }

        /* TOOLBAR */
        #toolbar { position: absolute; top: 10px; left: 360px; right: 20px; height: 60px; background: white; border-radius: 8px; display: flex; align-items: center; padding: 0 15px; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 100; overflow-x: auto; }
        .tool-group { border-right: 1px solid #eee; padding-right: 10px; display: flex; gap: 5px; align-items: center; }
        .t-btn { border: 1px solid #ddd; background: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .t-btn:hover { background: #f0f0f0; }
        .btn-save { background: #222; color: #C59D5F; border: none; font-weight: bold; margin-left: auto;}

        /* MODAL EDICI√ìN */
        #edit-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center; }
        .edit-card { background:white; padding:20px; border-radius:8px; width:320px; box-shadow:0 5px 20px rgba(0,0,0,0.3); }
        .edit-form label { display:block; margin:10px 0 5px; font-weight:bold; font-size:0.9rem; }
        .edit-form input, .edit-form select { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
        .edit-row { display: flex; gap: 10px; }
        .edit-actions { margin-top:20px; display:flex; justify-content:space-between; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header"><h3 style="margin:0">INVITADOS</h3><small id="stats-display">Cargando...</small></div>
        <div class="search-box">
            <input type="text" id="search" placeholder="Buscar..." onkeyup="filterGuests()">
            <button class="t-btn" onclick="groupByFamily()" title="Agrupar"><i class="fa-solid fa-users"></i></button>
        </div>
        <div style="padding:5px 10px; font-size:0.7rem; display:flex; gap:5px; flex-wrap:wrap; background:#eee;">
            <span style="color:var(--nino)">‚óè Ni√±o</span> <span style="color:var(--vegano)">‚óè Vegano</span>
        </div>
        <div id="guest-pool"></div>
    </div>

    <div id="toolbar">
        <div class="tool-group">
            <span style="font-size:0.7rem; color:#999;">MESAS:</span>
            <button class="t-btn" onclick="addObj('table', 'round')"><i class="fa-regular fa-circle"></i></button>
            <button class="t-btn" onclick="addObj('table', 'square')"><i class="fa-regular fa-square"></i></button>
            <button class="t-btn" onclick="addObj('table', 'rect')"><i class="fa-solid fa-vector-square"></i></button>
        </div>
        <div class="tool-group">
            <span style="font-size:0.7rem; color:#999;">FIJOS:</span>
            <button class="t-btn" onclick="addObj('fixed', 'dj')" title="DJ">üéß</button>
            <button class="t-btn" onclick="addObj('fixed', 'dance')" title="Pista">üíÉ</button>
            <button class="t-btn" onclick="addObj('fixed', 'wc')" title="Ba√±os">üöª</button>
            <button class="t-btn" onclick="addObj('fixed', 'novios')" title="Novios">üíë</button>
            <button class="t-btn" onclick="addObj('fixed', 'exit')" title="Entrada">üö™</button>
        </div>
        <div class="tool-group">
            <button class="t-btn" onclick="editSalonBorder()" title="Editar Bordes del Sal√≥n"><i class="fa-solid fa-crop"></i> Bordes</button>
        </div>
        <button class="t-btn btn-save" onclick="saveData()"><i class="fa-solid fa-floppy-disk"></i> GUARDAR</button>
        <button class="t-btn" onclick="clearLocalLayout()" style="color:red; border:none; margin-left:10px;" title="Reiniciar Mapa"><i class="fa-solid fa-trash"></i></button>
    </div>

    <div id="canvas-area">
        <div id="canvas-content">
            <div id="salon-border" style="left: 100px; top: 100px; width: 2800px; height: 1800px;"></div>
        </div>
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()" title="Acercar">+</button>
            <div class="zoom-level" id="zoom-level">100%</div>
            <button class="zoom-btn" onclick="zoomOut()" title="Alejar">‚àí</button>
            <button class="zoom-btn" onclick="resetZoom()" title="Restablecer">‚åÇ</button>
        </div>
    </div>

    <div id="edit-modal">
        <div class="edit-card">
            <h3 style="margin-top:0">Editar Mesa</h3>
            <div class="edit-form">
                <label>Nombre / N√∫mero:</label>
                <input type="text" id="edit-name">
                
                <div class="edit-row">
                    <div style="flex:1">
                         <label>Forma:</label>
                        <select id="edit-shape">
                            <option value="round">Redonda</option>
                            <option value="square">Cuadrada</option>
                            <option value="rect">Rectangular</option>
                        </select>
                    </div>
                    <div style="flex:1">
                         <label>Capacidad:</label>
                        <input type="number" id="edit-capacity" min="1" max="50">
                    </div>
                </div>

                <div class="edit-row">
                    <div style="flex:1">
                        <label>Ancho (px):</label>
                        <input type="number" id="edit-width" step="10">
                    </div>
                    <div style="flex:1">
                        <label>Alto (px):</label>
                        <input type="number" id="edit-height" step="10">
                    </div>
                </div>
                
                <div class="edit-row">
                     <div style="flex:1">
                        <label>Rotaci√≥n (¬∞):</label>
                        <input type="number" id="edit-rotation" step="15" value="0">
                    </div>
                </div>

            </div>
            <div class="edit-actions">
                <button class="t-btn" style="color:red; border-color:red;" onclick="deleteSelectedTable()">Borrar</button>
                <button class="t-btn" onclick="document.getElementById('edit-modal').style.display='none'">Cancelar</button>
                <button class="t-btn" style="background:var(--novio); color:white; border:none;" onclick="saveTableEdits()">Aplicar</button>
            </div>
        </div>
    </div>

<script>
    // üëá URL DEL APPS SCRIPT (ACTUALIZADA)
    const API_URL = "https://script.google.com/macros/s/AKfycbxj8mTpblVwa2_pqKR5WpIQ-D0whwVWJxiREY5-yFCq0wjs9KWCEjCzPUL4Fm0DTCA/exec"; 
    
    let guests = [], mapElements = [], isGroupedByFamily = false;
    let editingTableId = null;
    let currentZoom = 1;
    let salonBorder = { x: 100, y: 100, width: 2800, height: 1800 };

    window.onload = async () => {
        // --- SEGURIDAD ---
        if(prompt("üîê Contrase√±a de Administrador:") !== "PYJ310524") { 
            document.body.innerHTML = "<div style='display:flex;height:100vh;justify-content:center;align-items:center;'><h1>‚õî Acceso Restringido</h1></div>"; 
            return; 
        }
        // -----------------

        loadLocalLayout();
        applyZoom(); // Aplicar zoom inicial
        try {
            const res = await fetchWithRetry(`${API_URL}?action=getAllConfirmed`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const text = await res.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (err) {
                alert("El servidor devolvi√≥ un error inesperado (probablemente HTML).");
                console.error("Error al parsear JSON:", text);
                throw new Error("Respuesta no es JSON.");
            }
            if(data.status === 'success') { 
                guests = data.guests; 
                syncGuestsWithLayout(); 
                syncTablesFromExcel();
                renderSidebar(); 
                
                if(mapElements.length === 0) autoCreateTablesFromExcel();
            }
        } catch(e) { 
            console.error(e);
            alert("Error cargando datos: " + e.message); 
        }
    };
    
    function loadLocalLayout() {
        const saved = localStorage.getItem('pj_floorplan');
        if(saved) {
            const data = JSON.parse(saved);
            mapElements = data.elements || data || [];
            if(data.salonBorder) salonBorder = data.salonBorder;
            updateSalonBorder();
            mapElements.forEach(el => renderElement(el, true)); 
        } else {
            updateSalonBorder();
        }
    }
    
    function updateSalonBorder() {
        const borderEl = document.getElementById('salon-border');
        if(borderEl) {
            borderEl.style.left = salonBorder.x + 'px';
            borderEl.style.top = salonBorder.y + 'px';
            borderEl.style.width = salonBorder.width + 'px';
            borderEl.style.height = salonBorder.height + 'px';
        }
    }
    
    function editSalonBorder() {
        const newX = prompt('Posici√≥n X del borde (px):', salonBorder.x);
        const newY = prompt('Posici√≥n Y del borde (px):', salonBorder.y);
        const newW = prompt('Ancho del sal√≥n (px):', salonBorder.width);
        const newH = prompt('Alto del sal√≥n (px):', salonBorder.height);
        
        if(newX !== null && newY !== null && newW !== null && newH !== null) {
            salonBorder.x = parseInt(newX) || salonBorder.x;
            salonBorder.y = parseInt(newY) || salonBorder.y;
            salonBorder.width = parseInt(newW) || salonBorder.width;
            salonBorder.height = parseInt(newH) || salonBorder.height;
            updateSalonBorder();
            saveLocalLayout();
        }
    }
    
    function zoomIn() {
        currentZoom = Math.min(currentZoom * 1.2, 3);
        applyZoom();
    }
    
    function zoomOut() {
        currentZoom = Math.max(currentZoom / 1.2, 0.2);
        applyZoom();
    }
    
    function resetZoom() {
        currentZoom = 1;
        applyZoom();
    }
    
    function applyZoom() {
        const content = document.getElementById('canvas-content');
        if(content) {
            content.style.transform = `scale(${currentZoom})`;
            document.getElementById('zoom-level').innerText = Math.round(currentZoom * 100) + '%';
        }
    }
    
    function autoCreateTablesFromExcel() {
        const mesas = [...new Set(guests.map(g => g.mesa).filter(m => m && m !== "Por asignar"))];
            mesas.forEach((m, i) => {
                const cols = 10;
                const spacing = 150; // Espaciado entre mesas en cm
                const x = salonBorder.x + 50 + (i % cols) * spacing;
                const y = salonBorder.y + 50 + Math.floor(i / cols) * spacing;
                
                const el = {
                    id: 'tbl_auto_' + m, type: 'table', subtype: 'round', x: x, y: y, 
                    guests: [], name: m, capacity: 10, width: 120, height: 120, rotation: 0
                };
            mapElements.push(el);
            renderElement(el, true);
        });
        
        guests.forEach(g => {
            if(g.mesa && g.mesa !== "Por asignar") {
                const tbl = mapElements.find(t => t.name === g.mesa);
                if(tbl) tbl.guests.push(g);
            }
        });
        mapElements.forEach(t => analyzeTableRules(t));
        saveLocalLayout();
    }

    function syncGuestsWithLayout() {
        mapElements.forEach(t => {
            if(t.type === 'table') {
                t.guests = t.guests.filter(gLoc => guests.find(gRem => gRem.id === gLoc.id));
                t.guests = t.guests.map(gLoc => guests.find(gRem => gRem.id === gLoc.id));
                analyzeTableRules(t);
            }
        });
    }

    function renderSidebar() {
        const list = document.getElementById('guest-pool');
        list.innerHTML = '';
        let displayGuests = [...guests];
        if(isGroupedByFamily) displayGuests.sort((a, b) => (a.groupId || "").localeCompare(b.groupId || ""));

        displayGuests.forEach(g => {
            const isAssigned = mapElements.some(t => t.type==='table' && t.guests.some(tg => tg.id === g.id));

            let typeClass = 'type-adulto', icons = '';
            const vibra = (g.vibra || "").toUpperCase(), tags = (g.tags || "").toUpperCase();

            if (tags.includes('NI√ëO') || vibra === 'NI√ëOS') typeClass = 'type-nino';
            else if (vibra === 'ADOLESCENTES') typeClass = 'type-adolescente';

            if (tags.includes('NI√ëO')) icons += '<i class="fa-solid fa-baby" title="Ni√±o"></i> ';
            if (tags.includes('VEGANO') || tags.includes('VEGETARIANO')) icons += '<i class="fa-solid fa-leaf" style="color:green"></i> ';
            if (g.movilidad === 'SILLA_RUEDAS') icons += '<i class="fa-solid fa-wheelchair"></i> ';

            const div = document.createElement('div');
            div.className = `guest-chip ${typeClass} draggable-guest`;
            if (isAssigned) div.classList.add('assigned'); 
            
            div.dataset.id = g.id;
            div.innerHTML = `<div><div style="font-weight:600">${g.nombre}</div><span class="family-tag">${g.groupId ? 'Fam. '+g.groupId : 'Indiv.'}</span></div><div class="icon-container">${icons}</div>`;
            list.appendChild(div);
        });
        document.getElementById('stats-display').innerText = `${guests.length} Confirmados`;
    }

    function groupByFamily() { isGroupedByFamily = !isGroupedByFamily; renderSidebar(); }
    function filterGuests() {
        const q = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('.guest-chip').forEach(el => {
            el.style.display = el.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
        });
    }

    function addObj(type, subtype) {
        const id = 'el_' + Date.now();
        let w=100, h=100;
        // Escala realista: 1px ‚âà 1cm
        if(subtype==='round') { w=120; h=120; } // Mesa redonda ~1.2m
        if(subtype==='rect') { w=180; h=90; } // Mesa rectangular ~1.8m x 0.9m
        if(subtype==='square') { w=120; h=120; } // Mesa cuadrada ~1.2m
        if(subtype==='novios') { w=200; h=80; } // Mesa novios ~2m x 0.8m
        if(subtype==='dance') { w=600; h=600; } // Pista de baile ~6m x 6m
        if(subtype==='dj') { w=200; h=100; } // √Årea DJ ~2m x 1m
        if(subtype==='wc') { w=150; h=150; } // Ba√±os ~1.5m x 1.5m
        if(subtype==='exit') { w=120; h=200; } // Entrada ~1.2m x 2m

        const elData = {
            id: id, type: type, subtype: subtype, 
            x: salonBorder.x + salonBorder.width / 2 - w/2, 
            y: salonBorder.y + salonBorder.height / 2 - h/2, 
            guests: [],
            name: type === 'table' ? `Mesa ${countTables()+1}` : subtype.toUpperCase(),
            capacity: 10, width: w, height: h, rotation: 0
        };
        mapElements.push(elData);
        renderElement(elData);
        saveLocalLayout();
    }

    function countTables() { return mapElements.filter(e => e.type === 'table').length; }

    function renderElement(data, isLoading=false) {
        const div = document.createElement('div');
        div.id = data.id;
        div.className = `map-obj shape-${data.subtype} obj-${data.subtype}`;
        if(data.type === 'fixed') div.classList.add('fixed-obj');
        
        div.style.width = `${data.width}px`;
        div.style.height = `${data.height}px`;
        div.style.transform = `translate(${data.x}px, ${data.y}px) rotate(${data.rotation||0}deg)`;
        div.dataset.id = data.id;
        
        if (data.type === 'table') {
            div.innerHTML = `
                <div class="table-name" style="transform: rotate(-${data.rotation||0}deg)">${data.name}</div>
                <div class="table-count" style="font-size:1.1rem; color:#666; transform: rotate(-${data.rotation||0}deg)">${data.guests.length}/${data.capacity}</div>
                <div class="table-alert" style="transform: rotate(-${data.rotation||0}deg)">! <div class="alert-tooltip"></div></div>
                <div class="vegan-indicator" style="transform: rotate(-${data.rotation||0}deg)"></div>
            `;
            setupDropzone(div);
        } else {
            let icon = '';
            if(data.subtype==='dj') icon = 'üéµ '; if(data.subtype==='wc') icon = 'üöª ';
            div.innerHTML = `<span style="transform: rotate(-${data.rotation||0}deg)">${icon}${data.name}</span>`;
        }
        setupDraggable(div);
        
        div.addEventListener('dblclick', (e) => {
            e.stopPropagation(); 
            if(data.type === 'table') openEditModal(data.id);
            else if(confirm("¬øBorrar elemento?")) deleteObj(data.id);
        });
        document.getElementById('canvas-content').appendChild(div);
        
        if(data.type === 'table' && !isLoading) analyzeTableRules(data);
        if(isLoading && data.type === 'table') setTimeout(()=>analyzeTableRules(data), 100); 
    }

    // --- EDICI√ìN ---
    function openEditModal(id) {
        const t = mapElements.find(e => e.id === id);
        if(!t) return;
        editingTableId = id;
        document.getElementById('edit-name').value = t.name;
        document.getElementById('edit-shape').value = t.subtype;
        document.getElementById('edit-capacity').value = t.capacity || 10;
        document.getElementById('edit-width').value = t.width;
        document.getElementById('edit-height').value = t.height;
        document.getElementById('edit-rotation').value = t.rotation || 0;
        document.getElementById('edit-modal').style.display = 'flex';
    }

    function saveTableEdits() {
        const t = mapElements.find(e => e.id === editingTableId);
        if(t) {
            t.name = document.getElementById('edit-name').value;
            t.subtype = document.getElementById('edit-shape').value;
            t.capacity = parseInt(document.getElementById('edit-capacity').value);
            t.width = parseInt(document.getElementById('edit-width').value);
            t.height = parseInt(document.getElementById('edit-height').value);
            t.rotation = parseInt(document.getElementById('edit-rotation').value);
            
            const div = document.getElementById(t.id);
            div.className = `map-obj shape-${t.subtype} obj-${t.subtype}`;
            div.style.width = t.width + 'px';
            div.style.height = t.height + 'px';
            div.style.transform = `translate(${t.x}px, ${t.y}px) rotate(${t.rotation}deg)`;
            
            const texts = div.querySelectorAll('.table-name, .table-count, .table-alert, .vegan-indicator, span');
            texts.forEach(el => el.style.transform = `rotate(-${t.rotation}deg)`);

            div.querySelector('.table-name').innerText = t.name;
            analyzeTableRules(t);
            saveLocalLayout();
        }
        document.getElementById('edit-modal').style.display = 'none';
    }

    function deleteSelectedTable() {
        if(confirm("¬øEliminar mesa y liberar invitados?")) deleteObj(editingTableId);
        document.getElementById('edit-modal').style.display = 'none';
    }

    function deleteObj(id) {
        const el = mapElements.find(e => e.id === id);
        if(el && el.type === 'table') {
            el.guests = []; 
            renderSidebar(); 
        }
        mapElements = mapElements.filter(e => e.id !== id);
        document.getElementById(id).remove();
        saveLocalLayout();
    }

    function analyzeTableRules(table) {
        let warnings = [];
        let veganCount = 0;
        const tableDiv = document.getElementById(table.id);
        
        tableDiv.querySelector('.table-count').innerText = `${table.guests.length}/${table.capacity}`;
        if(table.guests.length >= table.capacity) tableDiv.classList.add('table-full');
        else tableDiv.classList.remove('table-full');

        table.guests.forEach(g => { if((g.tags||"").includes('VEGAN')) veganCount++; });
        const veganBadge = tableDiv.querySelector('.vegan-indicator');
        veganBadge.style.display = veganCount > 0 ? 'block' : 'none';
        veganBadge.innerText = `ü•ó ${veganCount}`;


        const kids = table.guests.filter(g => (g.tags||"").includes('NI√ëO'));
        kids.forEach(kid => {
            const hasParent = table.guests.some(ad => ad.groupId === kid.groupId && ad.id !== kid.id && !ad.tags.includes('NI√ëO'));
            if (!hasParent) warnings.push(`üö® ALERTA: Ni√±o solo (${kid.nombre.split(' ')[0]})`);
        });

        const hasTeens = table.guests.some(g => (g.vibra||"").toUpperCase() === 'ADOLESCENTES');
        const hasElders = table.guests.some(g => (g.vibra||"").toUpperCase() === 'MAYORES');
        if (hasTeens && hasElders) warnings.push("‚ö†Ô∏è AMBIENTE: Adolescentes y Mayores.");

        if (hasElders) {
             const noise = mapElements.filter(e => e.subtype === 'dj' || e.subtype === 'dance');
             noise.forEach(obj => {
                const dist = Math.hypot(table.x - obj.x, table.y - obj.y);
                if(dist < 250) warnings.push("üîä RUIDO: Mesa de mayores cerca del DJ.");
             });
        }
        
        const hasWheelchair = table.guests.some(g => g.movilidad === 'SILLA_RUEDAS');
        if (hasWheelchair) {
             const wc = mapElements.find(e => e.subtype === 'wc');
             if(wc) {
                 const dist = Math.hypot(table.x - wc.x, table.y - wc.y);
                 if(dist > 600) warnings.push("‚ôø ACCESIBILIDAD: Lejos de ba√±os.");
             }
        }

        const alertIcon = tableDiv.querySelector('.table-alert');
        const tooltip = tableDiv.querySelector('.alert-tooltip');
        
        if (warnings.length > 0) {
            alertIcon.style.display = 'flex'; tooltip.innerHTML = warnings.join('<br>');
            tableDiv.style.borderColor = warnings.some(w => w.includes('üö®')) ? 'red' : '#ff9800';
        } else {
            alertIcon.style.display = 'none'; tableDiv.style.borderColor = 'white';
        }
    }

    // --- INTERACT ---
    function setupDraggable(el) {
        interact(el).draggable({
            inertia: true,
            modifiers: [ interact.modifiers.restrictRect({ 
                restriction: function() {
                    // Restringir dentro de los bordes del sal√≥n
                    return {
                        left: salonBorder.x,
                        top: salonBorder.y,
                        right: salonBorder.x + salonBorder.width,
                        bottom: salonBorder.y + salonBorder.height
                    };
                },
                endOnly: true 
            }) ],
            listeners: {
                move(event) {
                    const t = event.target;
                    const id = t.dataset.id;
                    const obj = mapElements.find(e => e.id === id);
                    
                    if(obj) {
                        obj.x += event.dx / currentZoom;
                        obj.y += event.dy / currentZoom;
                        t.style.transform = `translate(${obj.x}px, ${obj.y}px) rotate(${obj.rotation||0}deg)`;
                    }
                },
                end(event) { 
                    const obj = mapElements.find(e => e.id === event.target.dataset.id);
                    if(obj && obj.type === 'table') analyzeTableRules(obj);
                    saveLocalLayout();
                }
            }
        });
    }
    
    // Hacer los bordes del sal√≥n editables despu√©s de que el DOM est√© listo
    function setupSalonBorderInteraction() {
        const borderEl = document.getElementById('salon-border');
        if(!borderEl) return;
        
        interact('#salon-border').draggable({
            modifiers: [
                interact.modifiers.restrict({
                    restriction: 'parent',
                    endOnly: true
                })
            ],
            listeners: {
                move(event) {
                    salonBorder.x += event.dx / currentZoom;
                    salonBorder.y += event.dy / currentZoom;
                    updateSalonBorder();
                },
                end() {
                    saveLocalLayout();
                }
            }
        }).resizable({
            edges: { left: true, right: true, bottom: true, top: true },
            modifiers: [
                interact.modifiers.restrict({
                    restriction: 'parent'
                })
            ],
            listeners: {
                move(event) {
                    const rect = event.rect;
                    salonBorder.width = Math.max(500, rect.width / currentZoom);
                    salonBorder.height = Math.max(500, rect.height / currentZoom);
                    salonBorder.x = rect.left / currentZoom;
                    salonBorder.y = rect.top / currentZoom;
                    updateSalonBorder();
                },
                end() {
                    saveLocalLayout();
                }
            }
        });
    }
    
    // Inicializar interacci√≥n de bordes despu√©s de cargar
    setTimeout(setupSalonBorderInteraction, 200);

    function setupDropzone(el) {
        interact(el).dropzone({
            accept: '.draggable-guest', overlap: 0.50,
            ondragenter: (e) => e.target.classList.add('drag-hover'),
            ondragleave: (e) => e.target.classList.remove('drag-hover'),
            ondrop: (e) => {
                assignGuest(e.relatedTarget.dataset.id, e.target.dataset.id);
                e.target.classList.remove('drag-hover');
            }
        });
    }

    interact('.draggable-guest').draggable({
        autoScroll: true,
        listeners: {
            move(event) {
                const t = event.target;
                const x = (parseFloat(t.getAttribute('data-x')) || 0) + event.dx;
                const y = (parseFloat(t.getAttribute('data-y')) || 0) + event.dy;
                t.style.transform = `translate(${x}px, ${y}px)`;
                t.setAttribute('data-x', x); t.setAttribute('data-y', y);
                t.style.zIndex = 9999; t.style.position = 'fixed';
            },
            end(event) {
                event.target.style.transform = 'none';
                event.target.setAttribute('data-x', 0); event.target.setAttribute('data-y', 0);
                event.target.style.position = 'relative'; event.target.style.zIndex = '';
            }
        }
    });

    function assignGuest(guestId, tableId) {
        const table = mapElements.find(e => e.id === tableId);
        const guest = guests.find(g => g.id === guestId);
        
        if(!table || !guest) return;
        if(table.guests.length >= table.capacity) { alert("Mesa llena"); return; }

        mapElements.forEach(t => {
            if(t.guests) t.guests = t.guests.filter(g => g.id !== guestId);
        });
        
        table.guests.push(guest);
        renderSidebar(); 
        analyzeTableRules(table);
        saveLocalLayout();
    }

    // --- PERSISTENCIA LOCAL Y REMOTA ---
    function saveLocalLayout() {
        localStorage.setItem('pj_floorplan', JSON.stringify({ 
            elements: mapElements, 
            salonBorder: salonBorder 
        }));
    }
    
    function clearLocalLayout() {
        if(confirm("¬øBorrar todo el dise√±o?")) {
            localStorage.removeItem('pj_floorplan');
            location.reload();
        }
    }

    async function fetchWithRetry(url, options = {}, retries = 3, backoff = 1000) {
        try {
            const response = await fetch(url, options);
            if (!response.ok && retries > 0) {
                console.warn(`Reintentando... intentos restantes: ${retries}`);
                await new Promise(r => setTimeout(r, backoff));
                return fetchWithRetry(url, options, retries - 1, backoff * 2);
            }
            return response;
        } catch (error) {
            if (retries > 0) {
                console.warn(`Error de red. Reintentando... ${retries}`);
                await new Promise(r => setTimeout(r, backoff));
                return fetchWithRetry(url, options, retries - 1, backoff * 2);
            }
            throw error;
        }
    }

    // --- FUNCI√ìN CORREGIDA (API) ---
    async function saveData() {
        const btn = document.querySelector('.btn-save'); 
        const originalText = btn.innerHTML;
        btn.innerText = "Guardando...";
        btn.disabled = true;

        const assignments = [];
        mapElements.forEach(t => {
            if(t.guests) t.guests.forEach(g => assignments.push({ id: g.id, mesa: t.name }));
        });

        try {
            const response = await fetchWithRetry(API_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: {'Content-Type': 'text/plain;charset=utf-8'},
                body: JSON.stringify({
                    action: 'SAVE_TABLES', 
                    assignments: assignments
                })
            });

            if(response.ok) {
                alert("¬°Distribuci√≥n guardada correctamente en Excel!");
            } else {
                throw new Error("Error en respuesta de servidor");
            }
        } catch(e) { 
            console.error(e);
            alert("Error al guardar. Verifica tu conexi√≥n: " + e.message); 
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function syncTablesFromExcel() {
        const mesasExcel = [...new Set(guests.map(g => g.mesa).filter(m => m && m !== "Por asignar"))];
        const mesasMapa = mapElements.filter(e => e.type === 'table').map(e => e.name);
        const nuevasMesas = mesasExcel.filter(m => !mesasMapa.includes(m));

        if (nuevasMesas.length > 0) {
            alert(`üì¢ Se encontraron ${nuevasMesas.length} mesas nuevas en el Excel.\nSe a√±adir√°n en la parte superior para que las acomodes.`);
            nuevasMesas.forEach((m, i) => {
                const el = {
                    id: 'tbl_sync_' + m + '_' + Date.now(), 
                    type: 'table', subtype: 'round', 
                    x: salonBorder.x + 50 + (i % 10) * 150, 
                    y: salonBorder.y + 50 + Math.floor(i / 10) * 150, 
                    guests: [], name: m, capacity: 10, 
                    width: 120, height: 120, rotation: 0
                };
                mapElements.push(el);
                renderElement(el);
            });
            saveLocalLayout();
        }
    }
</script>
</body>
</html>