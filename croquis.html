<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner de Mesas | P&J</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Cinzel:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

    <style>
        /* --- PALETA MONOCROM√ÅTICA & GOLD --- */
        :root {
            --gold: #C59D5F; 
            --dark: #222222; 
            --gray: #666666;
            --light-gray: #e0e0e0;
            --white: #ffffff;
            
            /* Alertas sutiles pero visibles */
            --alert-red: #d32f2f;
            --alert-bg: #ffebee;
        }
        
        body { 
            font-family: 'Montserrat', sans-serif; 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            background: #333; /* Fondo oscuro fuera del lienzo para contraste */
        }
        
        /* --- SIDEBAR --- */
        #sidebar { 
            width: 320px; 
            background: var(--white); 
            border-right: 1px solid #999; 
            display: flex; 
            flex-direction: column; 
            z-index: 20; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.3); flex-shrink: 0;
        }
        
        .sidebar-header { 
            padding: 15px; 
            background: var(--dark); 
            color: var(--white); 
            text-align: center; 
            border-bottom: 2px solid var(--gold); 
        }
        .sidebar-header h3 { margin: 0; font-family: 'Cinzel', serif; letter-spacing: 1px; }

        .search-box { padding: 10px; background: #f4f4f4; border-bottom: 1px solid #ddd; display: flex; gap:5px; }
        .search-box input { flex:1; padding: 8px; border: 1px solid #ccc; border-radius: 2px; }
        .t-btn-icon { padding: 0 10px; cursor: pointer; border: 1px solid #ccc; background: white; border-radius: 2px; }

        .filters { padding: 5px 10px; font-size: 0.7rem; background: #eee; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; }

        #guest-pool { flex: 1; overflow-y: auto; padding: 10px; background: #fafafa; }

        /* CHIPS (INVITADOS) */
        .guest-chip { 
            background: white; padding: 8px; margin-bottom: 4px; border-radius: 3px; 
            border: 1px solid #ddd; cursor: grab; font-size: 0.75rem; 
            display: flex; justify-content: space-between; align-items: center; 
            border-left: 3px solid #999; /* Default neutro */
            user-select: none;
        }
        .guest-chip:hover { border-color: var(--gold); background: #fffcf5; }
        .guest-chip.assigned { display: none; }
        
        /* Tags minimalistas */
        .tag-nino { border-left-color: #ffd54f; }
        .tag-ex { border-left-color: #8d6e63; }
        .tag-vegano { border-left-color: #81c784; }
        .tag-confirmed { border-left-color: var(--dark); } /* Confirmados en negro s√≥lido */

        /* --- VIEWPORT --- */
        #viewport { 
            flex: 1; position: relative; overflow: hidden; 
            background-color: #555; 
            cursor: grab; 
        }
        #viewport:active { cursor: grabbing; }

        /* SAL√ìN (LIENZO) */
        #room-container {
            position: absolute;
            top: 0; left: 0;
            width: 3000px; height: 3000px;
            background-color: #f0f0f0;
            /* Cuadr√≠cula arquitect√≥nica sutil */
            background-image: 
                linear-gradient(#dcdcdc 1px, transparent 1px),
                linear-gradient(90deg, #dcdcdc 1px, transparent 1px);
            background-size: 50px 50px;
            transform-origin: 0 0;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* OBJETOS (ESTILO MONOCROMO) */
        .map-obj { 
            position: absolute; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            text-align: center; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); cursor: default; touch-action: none; 
            border: 1px solid #333; /* Borde fino negro */
            font-weight: 600; font-size: 0.75rem; color: #333; 
            background: white; overflow: hidden; user-select: none;
        }
        
        .shape-round { border-radius: 50%; }
        .shape-rect { border-radius: 2px; }

        /* ESTILOS ESPEC√çFICOS LIMPIOS */
        /* Mesas */
        .obj-table { background: white; }
        
        /* Fijos (Sin colores chillantes) */
        .fixed-obj { z-index: 5; border: 1px solid #666; background: #e8e8e8; color: #444; }
        
        .obj-novios { 
            background: white; color: var(--gold); 
            border: 2px solid var(--gold); /* Solo novios llevan dorado */
            z-index: 10; font-family: 'Cinzel', serif;
        }
        
        .obj-dance { 
            background: repeating-linear-gradient(
                45deg,
                #f0f0f0,
                #f0f0f0 10px,
                #e0e0e0 10px,
                #e0e0e0 20px
            );
            border: 1px dashed #999; color: #666; z-index: 1; 
        }
        
        .obj-dj { background: #333; color: white; border: none; }
        .obj-wc, .obj-exit { background: white; border: 1px solid #999; color: #666; }

        /* Estados */
        .table-full { background-color: #f5f5f5; color: #999; border-color: #ccc; } /* Mesa llena se apaga */
        .drag-hover { border-color: var(--gold) !important; box-shadow: 0 0 0 2px var(--gold); }
        
        /* Alertas (Peque√±o punto rojo) */
        .table-alert { 
            position: absolute; top: 0; right: 0; width: 16px; height: 16px; 
            background: var(--alert-red); color: white; border-radius: 50%; 
            display: none; justify-content: center; align-items: center; 
            font-size: 0.6rem; z-index: 15;
        }
        .vegan-badge { 
            position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); 
            background: #fff; border: 1px solid #81c784; color: #2e7d32; font-size: 0.6rem; 
            padding: 1px 4px; border-radius: 4px; display: none; white-space: nowrap; 
        }
        
        .alert-tooltip { 
            position: absolute; bottom: 105%; left: 50%; transform: translateX(-50%); 
            background: var(--dark); color: var(--gold); padding: 5px 10px; border-radius: 2px; 
            font-size: 0.7rem; width: 140px; display: none; z-index: 200; pointer-events: none; text-align: center;
        }
        .map-obj:hover .alert-tooltip { display: block; }

        /* TOOLBAR */
        #toolbar { 
            position: absolute; top: 15px; left: 340px; right: 20px; height: 50px; 
            background: var(--white); border-radius: 4px; display: flex; align-items: center; 
            padding: 0 10px; gap: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 100; overflow-x: auto;
        }
        .t-btn { 
            padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 2px; 
            cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 5px; min-width: max-content;
            color: #444; font-weight: 600;
        }
        .t-btn:hover { background: #f5f5f5; border-color: #999; }
        .t-btn i { color: #555; }
        
        /* ZOOM CONTROLS */
        .zoom-controls { 
            position: absolute; bottom: 30px; right: 30px; 
            display: flex; flex-direction: column; gap: 5px; z-index: 100; 
        }
        .zoom-btn { 
            width: 40px; height: 40px; background: white; border: 1px solid #ccc; border-radius: 4px; 
            font-size: 1rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            display: grid; place-items: center; color: var(--dark);
        }
        .zoom-btn:hover { background: #f0f0f0; }

        /* MODAL */
        #edit-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; }
        .edit-card { background:white; padding:25px; border-radius:4px; width:350px; max-height: 80vh; display: flex; flex-direction: column; border-top: 4px solid var(--gold); }
        
        .guest-list-edit { flex: 1; overflow-y: auto; border: 1px solid #eee; margin: 10px 0; padding: 5px; background: #fafafa; }
        .gl-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; background: white; font-size: 0.8rem; align-items: center;}
        .btn-kick { color: #d32f2f; cursor: pointer; font-weight: bold; font-size: 0.9rem;}

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <h3>PLANNER P&J</h3>
            <small id="stats-display">Cargando...</small>
            <button onclick="logout()" style="background:none; border:none; color:#aaa; cursor:pointer; margin-top:5px; font-size:0.7rem; text-decoration:underline;">Cerrar Sesi√≥n</button>
        </div>
        <div class="search-box">
            <input type="text" id="search" placeholder="Buscar..." onkeyup="filterGuests()">
            <button class="t-btn-icon" onclick="toggleFamilyGroup()"><i class="fa-solid fa-users"></i></button>
        </div>
        <div class="filters">
            <div><span style="color:#ffd54f">‚óè Ni√±o</span> <span style="color:#8d6e63">‚óè EX</span></div>
            <label style="display:flex; align-items:center; gap:5px; cursor:pointer;"><input type="checkbox" id="show-pending" onchange="renderSidebar()"> Ver Pendientes</label>
        </div>
        <div id="guest-pool"></div>
    </div>

    <div id="toolbar">
        <button class="t-btn" onclick="addObj('table', 'round')"><i class="fa-regular fa-circle"></i> Redonda</button>
        <button class="t-btn" onclick="addObj('table', 'rect')"><i class="fa-solid fa-vector-square"></i> Rectangular</button>
        <div style="width:1px; height:20px; background:#ddd;"></div>
        <button class="t-btn" onclick="addObj('fixed', 'dance')"><i class="fa-solid fa-music"></i> Pista</button>
        <button class="t-btn" onclick="addObj('fixed', 'dj')"><i class="fa-solid fa-headphones"></i> DJ</button>
        <button class="t-btn" onclick="addObj('fixed', 'novios')"><i class="fa-solid fa-heart" style="color:var(--gold)"></i> Novios</button>
        <button class="t-btn" onclick="addObj('fixed', 'wc')"><i class="fa-solid fa-restroom"></i> Ba√±os</button>
        <button class="t-btn" onclick="addObj('fixed', 'exit')"><i class="fa-solid fa-door-open"></i> Entrada</button>
        <button class="t-btn" onclick="saveData()" style="margin-left:auto; background:var(--dark); color:white; border:none;">GUARDAR</button>
        <button class="t-btn" onclick="clearLocalLayout()" style="color:#d32f2f; border:none;"><i class="fa-solid fa-trash"></i></button>
    </div>

    <div id="viewport">
        <div id="room-container"></div>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()"><i class="fa-solid fa-plus"></i></button>
        <button class="zoom-btn" onclick="resetZoom()"><i class="fa-solid fa-compress"></i></button>
        <button class="zoom-btn" onclick="zoomOut()"><i class="fa-solid fa-minus"></i></button>
    </div>

    <div id="edit-modal">
        <div class="edit-card">
            <h3 style="margin:0 0 15px 0; font-family:'Cinzel',serif; color:var(--dark); border-bottom:1px solid #eee; padding-bottom:10px;">Configurar</h3>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                <div><label style="font-size:0.7rem; font-weight:bold; color:#999;">NOMBRE</label><input type="text" id="edit-name" style="width:100%; padding:5px;"></div>
                <div><label style="font-size:0.7rem; font-weight:bold; color:#999;">CAPACIDAD</label><input type="number" id="edit-capacity" style="width:100%; padding:5px;"></div>
                <div><label style="font-size:0.7rem; font-weight:bold; color:#999;">ANCHO</label><input type="number" id="edit-w" style="width:100%; padding:5px;"></div>
                <div><label style="font-size:0.7rem; font-weight:bold; color:#999;">ALTO</label><input type="number" id="edit-h" style="width:100%; padding:5px;"></div>
                <div><label style="font-size:0.7rem; font-weight:bold; color:#999;">ROTACI√ìN</label><input type="number" id="edit-rot" step="15" style="width:100%; padding:5px;"></div>
            </div>
            
            <h4 style="margin:5px 0; font-size:0.8rem; color:#666;">Invitados (<span id="count-seated">0</span>)</h4>
            <div class="guest-list-edit" id="table-guest-list"></div>

            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button style="color:red; background:none; border:1px solid #ffcdd2; padding:8px 12px; border-radius:4px; cursor:pointer;" onclick="deleteSelectedElement()">Eliminar</button>
                <div style="display:flex; gap:10px;">
                    <button style="background:none; border:1px solid #ccc; padding:8px 12px; border-radius:4px; cursor:pointer;" onclick="document.getElementById('edit-modal').style.display='none'">Cancelar</button>
                    <button style="background:var(--gold); color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; font-weight:bold;" onclick="saveElementEdits()">Aplicar</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // URL APPS SCRIPT
    const API_URL = "https://script.google.com/macros/s/AKfycbyKWw1ST_THRFt9joUGpKDLVxM1goT_PxZ6nmXw1-9luzRPi7JX_MZmQ5k4GY2dVUw/exec"; 
    const PASS_HASH = "UFlKMzEwNTI0"; 

    // Variables Zoom/Pan
    let scale = 1;
    let panX = 0; let panY = 0;
    
    // Estado
    let guests = [];
    let mapElements = [];
    let isGroupedByFamily = false;
    let editingElementId = null;

    window.onload = async () => {
        // Auth
        if(!localStorage.getItem('pj_planner_auth')) {
            if(btoa(prompt("üîê Password Admin:")) !== PASS_HASH) { 
                document.body.innerHTML = "<div style='height:100vh;display:flex;justify-content:center;align-items:center;'><h1>‚õî Acceso Denegado</h1></div>"; 
                return; 
            }
            localStorage.setItem('pj_planner_auth', 'true');
        }

        loadLocalLayout();
        initPanZoom(); 

        try {
            const res = await fetch(`${API_URL}?action=getAllConfirmed`);
            const data = await res.json();
            if(data.status === 'success') { 
                guests = data.guests;
                syncDataState(); 
                if(mapElements.length === 0) autoCreateTablesFromExcel();
                renderSidebar();
            }
        } catch(e) { alert("Modo Offline"); }
    };

    function logout() { localStorage.removeItem('pj_planner_auth'); location.reload(); }

    // --- ZOOM & PAN ---
    function initPanZoom() {
        const viewport = document.getElementById('viewport');
        const room = document.getElementById('room-container');
        let isPanning = false, startX = 0, startY = 0;

        viewport.addEventListener('mousedown', (e) => {
            if (e.target === viewport || e.target === room) {
                isPanning = true; startX = e.clientX - panX; startY = e.clientY - panY;
                viewport.style.cursor = 'grabbing';
            }
        });
        window.addEventListener('mouseup', () => { isPanning = false; viewport.style.cursor = 'grab'; });
        window.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            e.preventDefault(); panX = e.clientX - startX; panY = e.clientY - startY;
            updateTransform();
        });
        viewport.addEventListener('wheel', (e) => {
            e.preventDefault(); const delta = e.deltaY > 0 ? 0.9 : 1.1; zoom(delta);
        }, { passive: false });
    }

    function zoom(factor) {
        if (typeof factor === 'number') { const newScale = scale * factor; if (newScale >= 0.2 && newScale <= 4) scale = newScale; } 
        else { if (factor === 'in') scale = Math.min(scale + 0.2, 4); if (factor === 'out') scale = Math.max(scale - 0.2, 0.2); }
        updateTransform();
    }
    function zoomIn() { zoom('in'); } function zoomOut() { zoom('out'); }
    function resetZoom() { scale = 1; panX = 0; panY = 0; updateTransform(); }
    function updateTransform() { document.getElementById('room-container').style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`; }

    // --- DATOS ---
    function loadLocalLayout() {
        const saved = localStorage.getItem('pj_floorplan_v8');
        if(saved) { mapElements = JSON.parse(saved); mapElements.forEach(el => renderElement(el, true)); }
    }
    function saveLocalLayout() { localStorage.setItem('pj_floorplan_v8', JSON.stringify(mapElements)); }

    function syncDataState() {
        mapElements.forEach(t => {
            if(t.type === 'table') {
                t.guests = t.guests.map(gLocal => guests.find(gRemote => gRemote.id === gLocal.id)).filter(g => g);
                analyzeTableRules(t);
                const div = document.getElementById(t.id);
                if(div) updateDivContent(div, t);
            }
        });
        const mesasExcel = [...new Set(guests.map(g => g.mesa).filter(m => m && m !== "Por asignar"))];
        const mesasMapa = mapElements.filter(e => e.type === 'table').map(e => e.name);
        mesasExcel.forEach((mName, i) => { if(!mesasMapa.includes(mName)) addObj('table', 'round', mName, true, i); });
    }
    function autoCreateTablesFromExcel() { syncDataState(); }

    // --- SIDEBAR ---
    function renderSidebar() {
        const container = document.getElementById('guest-pool'); container.innerHTML = '';
        const showPending = document.getElementById('show-pending').checked;
        
        let list = guests.filter(g => (g.rsvp||"").toUpperCase().includes('SI') || showPending);
        
        const q = document.getElementById('search').value.toLowerCase();
        if(q) list = list.filter(g => g.nombre.toLowerCase().includes(q) || (g.groupId||'').toLowerCase().includes(q));

        if(isGroupedByFamily) list.sort((a,b) => (a.groupId||'').localeCompare(b.groupId||''));
        else list.sort((a,b) => a.nombre.localeCompare(b.nombre));

        const assignedIds = mapElements.flatMap(t => t.guests ? t.guests.map(g=>g.id) : []);

        list.forEach(g => {
            if(assignedIds.includes(g.id)) return;

            const div = document.createElement('div');
            let tagClass = 'tag-default';
            const tags = (g.tags || "").toUpperCase();
            if((g.rsvp||'').includes('SI')) tagClass = 'tag-confirmed';
            if(tags.includes('NI√ëO')) tagClass = 'tag-nino';
            if(tags.includes('EX')) tagClass = 'tag-ex';
            if(tags.includes('VEGAN')) tagClass = 'tag-vegano';

            div.className = `guest-chip draggable-guest ${tagClass}`;
            div.dataset.id = g.id;
            div.innerHTML = `<div><span class="guest-name">${g.nombre}</span><span class="guest-group">${g.groupId || 'Individual'}</span></div>`;
            container.appendChild(div);
        });
        document.getElementById('stats-display').innerText = `Lista: ${list.length} | Faltan: ${list.length - assignedIds.length}`;
    }

    function filterGuests() { renderSidebar(); }
    function toggleFamilyGroup() { isGroupedByFamily = !isGroupedByFamily; renderSidebar(); }

    // --- ELEMENTOS ---
    function addObj(type, subtype, forceName=null, autoPosition=false, idx=0) {
        const id = 'el_' + Date.now() + Math.floor(Math.random()*1000);
        let w=120, h=120, name = forceName || subtype.toUpperCase();
        let x=200, y=200;

        if(subtype === 'round') { w=120; h=120; if(!forceName) name=`Mesa ${countTables()+1}`; }
        if(subtype === 'rect') { w=160; h=90; if(!forceName) name=`Mesa ${countTables()+1}`; }
        if(subtype === 'dance') { w=300; h=250; name="PISTA"; }
        if(subtype === 'dj') { w=150; h=80; name="DJ"; }
        
        if(autoPosition) { x = 100 + (idx % 6) * 160; y = 100 + Math.floor(idx / 6) * 160; }
        else { x = 200 - panX; y = 200 - panY; }

        const el = { id, type, subtype, x, y, w, h, name, rotation: 0, capacity: 10, guests: [] };
        
        if(forceName && type==='table') {
            el.guests = guests.filter(g => g.mesa === forceName && (g.rsvp.includes('SI') || g.rsvp.includes('CONFIRMADO')));
        }
        
        mapElements.push(el); renderElement(el); saveLocalLayout();
    }
    
    function countTables() { return mapElements.filter(e => e.type === 'table').length; }

    function renderElement(data, init=false) {
        const div = document.createElement('div');
        div.id = data.id; div.dataset.id = data.id;
        div.className = `map-obj shape-${data.subtype}`;
        if(data.type === 'fixed') div.classList.add('fixed-obj', `obj-${data.subtype}`);
        else div.classList.add('obj-table');

        updateDivGeometry(div, data);
        updateDivContent(div, data);

        div.addEventListener('dblclick', (e) => { e.stopPropagation(); openEditModal(data.id); });

        document.getElementById('room-container').appendChild(div);
        initInteract(div, data);
        if(data.type === 'table') setupDropzone(div);
        if(!init && data.type === 'table') analyzeTableRules(data);
    }

    function updateDivGeometry(div, data) {
        div.style.width = `${data.w}px`; div.style.height = `${data.h}px`;
        div.style.transform = `translate(${data.x}px, ${data.y}px) rotate(${data.rotation}deg)`;
    }

    function updateDivContent(div, data) {
        const counterRot = `rotate(-${data.rotation}deg)`;
        if(data.type === 'table') {
             div.innerHTML = `<div style="transform:${counterRot}; width:100%;">
                <div style="font-weight:700">${data.name}</div>
                <small style="color:#666">${data.guests.length}/${data.capacity}</small>
                <div class="table-alert">!</div><div class="alert-tooltip"></div><div class="vegan-badge"></div>
             </div>`;
             div.className = `map-obj shape-${data.subtype} ${data.guests.length>=data.capacity ? 'table-full':''}`;
        } else {
             div.innerHTML = `<div style="transform:${counterRot}">${data.name}</div>`;
        }
    }

    // --- INTERACT ---
    function initInteract(div, data) {
        const interactable = interact(div).draggable({
            listeners: {
                move(e) {
                    const t = e.target, id = t.dataset.id, obj = mapElements.find(o=>o.id===id);
                    obj.x += e.dx / scale; obj.y += e.dy / scale;
                    updateDivGeometry(t, obj);
                },
                end() { saveLocalLayout(); }
            },
            modifiers: [ interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true }) ]
        });

        if(data.subtype === 'rect' || data.type === 'fixed') {
            interactable.resizable({
                edges: { left: true, right: true, bottom: true, top: true },
                listeners: {
                    move(e) {
                        const t = e.target, id = t.dataset.id, obj = mapElements.find(o=>o.id===id);
                        obj.w = e.rect.width / scale; obj.h = e.rect.height / scale;
                        obj.x += e.deltaRect.left / scale; obj.y += e.deltaRect.top / scale;
                        updateDivGeometry(t, obj);
                    },
                    end() { saveLocalLayout(); }
                }
            });
        }
    }

    interact('.draggable-guest').draggable({
        autoScroll: true,
        listeners: {
            move(e) {
                const t = e.target;
                const x = (parseFloat(t.getAttribute('data-x'))||0) + e.dx;
                const y = (parseFloat(t.getAttribute('data-y'))||0) + e.dy;
                t.style.transform = `translate(${x}px, ${y}px)`;
                t.setAttribute('data-x', x); t.setAttribute('data-y', y);
                t.style.zIndex = 9999; t.style.position = 'fixed';
            },
            end(e) {
                e.target.style.transform = 'none'; e.target.setAttribute('data-x', 0); e.target.setAttribute('data-y', 0); e.target.style.position = ''; e.target.style.zIndex = '';
            }
        }
    });

    function setupDropzone(div) {
        interact(div).dropzone({
            accept: '.draggable-guest', overlap: 0.50,
            ondragenter: (e) => e.target.classList.add('drag-hover'),
            ondragleave: (e) => e.target.classList.remove('drag-hover'),
            ondrop: (e) => {
                e.target.classList.remove('drag-hover');
                assignGuestToTable(e.relatedTarget.dataset.id, e.target.dataset.id);
            }
        });
    }

    function assignGuestToTable(guestId, tableId) {
        const table = mapElements.find(e => e.id === tableId);
        const guest = guests.find(g => g.id === guestId);
        if(!table || !guest) return;
        if(table.guests.length >= table.capacity) { alert("¬°Mesa llena!"); return; }
        
        mapElements.forEach(m => { if(m.guests) m.guests = m.guests.filter(x => x.id !== guestId); });
        table.guests.push(guest);
        
        analyzeTableRules(table);
        updateDivContent(document.getElementById(table.id), table);
        renderSidebar(); 
        saveLocalLayout();
    }

    function analyzeTableRules(table) {
        const div = document.getElementById(table.id);
        if(!div) return;
        let warnings = [], veganCount = 0;
        table.guests.forEach(g => { if((g.tags||"").includes('VEGAN')) veganCount++; });
        const badge = div.querySelector('.vegan-badge');
        if(badge) { badge.style.display = veganCount > 0 ? 'block' : 'none'; badge.innerText = `ü•ó ${veganCount}`; }
        if(table.guests.some(g => (g.tags||"").includes('EX'))) warnings.push("üíî Alerta: EX");
        const kids = table.guests.filter(g => (g.tags||"").includes('NI√ëO'));
        kids.forEach(k => { if(!table.guests.some(a => a.groupId === k.groupId && !a.tags.includes('NI√ëO'))) warnings.push("üë∂ Ni√±o solo"); });
        const alertIcon = div.querySelector('.table-alert');
        const tooltip = div.querySelector('.alert-tooltip');
        if(warnings.length > 0) {
            alertIcon.style.display = 'flex'; tooltip.innerHTML = warnings.join('<br>'); div.style.borderColor = 'red';
        } else {
            alertIcon.style.display = 'none'; div.style.borderColor = 'white';
        }
    }

    // --- MODAL ---
    function openEditModal(id) {
        const el = mapElements.find(e => e.id === id);
        editingElementId = id;
        document.getElementById('edit-modal').style.display = 'flex';
        document.getElementById('edit-name').value = el.name;
        document.getElementById('edit-capacity').value = el.capacity || 10;
        document.getElementById('edit-w').value = Math.round(el.w);
        document.getElementById('edit-h').value = Math.round(el.h);
        document.getElementById('edit-rot').value = el.rotation || 0;
        
        const list = document.getElementById('table-guest-list');
        list.innerHTML = '';
        if(el.type === 'table') {
            document.getElementById('count-seated').innerText = el.guests.length;
            el.guests.forEach(g => {
                list.innerHTML += `<div class="gl-item"><div><strong>${g.nombre}</strong><br><small>${g.groupId}</small></div><span class="btn-kick" onclick="kickGuest('${g.id}')">‚úï</span></div>`;
            });
        }
    }

    function kickGuest(guestId) {
        const t = mapElements.find(e => e.id === editingElementId);
        t.guests = t.guests.filter(g => g.id !== guestId);
        analyzeTableRules(t);
        updateDivContent(document.getElementById(t.id), t);
        saveLocalLayout();
        renderSidebar();
        openEditModal(editingElementId);
    }

    function saveElementEdits() {
        const el = mapElements.find(e => e.id === editingElementId);
        if(el) {
            el.name = document.getElementById('edit-name').value;
            el.w = parseInt(document.getElementById('edit-w').value);
            el.h = parseInt(document.getElementById('edit-h').value);
            el.rotation = parseInt(document.getElementById('edit-rot').value);
            if(el.type === 'table') {
                el.capacity = parseInt(document.getElementById('edit-capacity').value);
                analyzeTableRules(el);
            }
            const div = document.getElementById(el.id);
            updateDivGeometry(div, el);
            updateDivContent(div, el);
            saveLocalLayout();
        }
        document.getElementById('edit-modal').style.display = 'none';
    }

    function deleteSelectedElement() {
        if(confirm("¬øEliminar?")) {
            const el = mapElements.find(e => e.id === editingElementId);
            if(el.type === 'table') { el.guests = []; renderSidebar(); }
            mapElements = mapElements.filter(e => e.id !== editingElementId);
            document.getElementById(editingElementId).remove();
            saveLocalLayout();
            document.getElementById('edit-modal').style.display = 'none';
        }
    }

    function clearLocalLayout() { if(confirm("¬øBorrar todo?")) { localStorage.removeItem('pj_floorplan_v8'); location.reload(); } }

    async function saveData() {
        const btn = document.querySelector('.btn-save'); btn.innerHTML = "GUARDANDO...";
        const assignments = [];
        mapElements.forEach(t => { if(t.guests) t.guests.forEach(g => assignments.push({id: g.id, mesa: t.name})); });
        try {
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'SAVE_TABLES', assignments: assignments }) });
            alert("‚úÖ Guardado");
        } catch(e) { alert("Error de red. Datos seguros localmente."); }
        btn.innerHTML = "GUARDAR";
    }
</script>
</body>
</html>