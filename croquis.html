<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Planner P&J</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

    <style>
        :root {
            --novio: #2196f3; --novia: #e91e63;
            --nino: #ffc107; --adolescente: #9c27b0;
            --joven: #ff5722; --adulto: #607d8b;
            --ex: #795548; --vegano: #4caf50;
        }
        body { font-family: 'Montserrat', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; background: #e0e0e0; }
        
        /* SIDEBAR */
        #sidebar { width: 340px; background: white; border-right: 1px solid #999; display: flex; flex-direction: column; z-index: 20; box-shadow: 2px 0 15px rgba(0,0,0,0.2); }
        .sidebar-header { padding: 15px; background: #1a1a1a; color: #C59D5F; text-align: center; }
        .search-box { padding: 10px; background: #f4f4f4; border-bottom: 1px solid #ddd; display: flex; gap:5px;}
        .search-box input { flex:1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #guest-pool { flex: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; }

        /* CHIPS */
        .guest-chip { background: white; padding: 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #ccc; cursor: grab; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; border-left-width: 5px; transition: all 0.2s; position: relative; }
        .guest-chip:hover { transform: translateX(5px); box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .guest-chip.assigned { opacity: 0.5; background: #e0e0e0; color: #888; filter: grayscale(1); pointer-events: none; } /* Deshabilitado si ya tiene mesa */
        
        .type-nino { border-left-color: var(--nino); background: #fffde7; }
        .type-adolescente { border-left-color: var(--adolescente); }
        .type-joven { border-left-color: var(--joven); }
        .type-adulto { border-left-color: var(--adulto); }
        .type-ex { border-left-color: var(--ex); }

        .family-tag { font-size: 0.65rem; color: #888; display: block; margin-top: 2px;}
        .icon-container { display: flex; gap: 3px; font-size: 0.9rem; }

        /* CANVAS */
        #canvas-area { flex: 1; position: relative; overflow: hidden; background-image: radial-gradient(#aaa 1px, transparent 1px); background-size: 20px 20px; touch-action: none; user-select: none; }

        /* OBJETOS MAPA */
        .map-obj { position: absolute; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.15); cursor: grab; touch-action: none; border: 3px solid white; font-weight: bold; font-size: 0.8rem; color: #333; transition: border-color 0.3s, box-shadow 0.2s; }
        
        /* Estilos Base de Formas */
        .shape-round { border-radius: 50%; }
        .shape-square { border-radius: 4px; }
        .shape-rect { border-radius: 4px; }

        .fixed-obj { color: white; z-index: 5; border: none !important; }
        .obj-novios { background: #C59D5F; border-radius: 30px; }
        .obj-dj { background: #333; border: 2px solid gold; border-radius: 4px; }
        .obj-dance { background: rgba(0,0,0,0.1); border: 2px dashed #666; z-index: 1; color: #666; }
        .obj-wc { background: #009688; border-radius: 8px; }
        .obj-exit { background: #4caf50; }

        .table-alert { position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; background: red; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; animation: pulse 1.5s infinite; display: none; z-index: 15; cursor: help; font-size: 1rem; }
        .map-obj.drag-hover { border-color: #C59D5F; transform: scale(1.05); z-index: 100; }
        .map-obj.table-full { background-color: #ffebee; }
        
        .vegan-indicator { position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); background: #4caf50; color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 10px; display: none; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .alert-tooltip { position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 8px; border-radius: 6px; font-size: 0.7rem; width: 180px; display: none; z-index: 20; pointer-events: none; text-align: left; }
        .table-alert:hover .alert-tooltip { display: block; }

        /* TOOLBAR */
        #toolbar { position: absolute; top: 10px; left: 360px; right: 20px; height: 60px; background: white; border-radius: 8px; display: flex; align-items: center; padding: 0 15px; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 100; overflow-x: auto; }
        .tool-group { border-right: 1px solid #eee; padding-right: 10px; display: flex; gap: 5px; align-items: center; }
        .t-btn { border: 1px solid #ddd; background: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .t-btn:hover { background: #f0f0f0; }
        .btn-save { background: #222; color: #C59D5F; border: none; font-weight: bold; margin-left: auto;}

        /* MODAL EDICI√ìN */
        #edit-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center; }
        .edit-card { background:white; padding:20px; border-radius:8px; width:320px; box-shadow:0 5px 20px rgba(0,0,0,0.3); }
        .edit-form label { display:block; margin:10px 0 5px; font-weight:bold; font-size:0.9rem; }
        .edit-form input, .edit-form select { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
        .edit-row { display: flex; gap: 10px; }
        .edit-actions { margin-top:20px; display:flex; justify-content:space-between; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header"><h3 style="margin:0">INVITADOS</h3><small id="stats-display">Cargando...</small></div>
        <div class="search-box">
            <input type="text" id="search" placeholder="Buscar..." onkeyup="filterGuests()">
            <button class="t-btn" onclick="groupByFamily()" title="Agrupar"><i class="fa-solid fa-users"></i></button>
        </div>
        <div style="padding:5px 10px; font-size:0.7rem; display:flex; gap:5px; flex-wrap:wrap; background:#eee;">
            <span style="color:var(--nino)">‚óè Ni√±o</span> <span style="color:var(--ex)">‚óè EX</span> <span style="color:var(--vegano)">‚óè Vegano</span>
        </div>
        <div id="guest-pool"></div>
    </div>

    <div id="toolbar">
        <div class="tool-group">
            <span style="font-size:0.7rem; color:#999;">MESAS:</span>
            <button class="t-btn" onclick="addObj('table', 'round')"><i class="fa-regular fa-circle"></i></button>
            <button class="t-btn" onclick="addObj('table', 'square')"><i class="fa-regular fa-square"></i></button>
            <button class="t-btn" onclick="addObj('table', 'rect')"><i class="fa-solid fa-vector-square"></i></button>
        </div>
        <div class="tool-group">
            <span style="font-size:0.7rem; color:#999;">FIJOS:</span>
            <button class="t-btn" onclick="addObj('fixed', 'dj')" title="DJ">üéß</button>
            <button class="t-btn" onclick="addObj('fixed', 'dance')" title="Pista">üíÉ</button>
            <button class="t-btn" onclick="addObj('fixed', 'wc')" title="Ba√±os">üöª</button>
            <button class="t-btn" onclick="addObj('fixed', 'novios')" title="Novios">üíë</button>
            <button class="t-btn" onclick="addObj('fixed', 'exit')" title="Entrada">üö™</button>
        </div>
        <button class="t-btn btn-save" onclick="saveData()"><i class="fa-solid fa-floppy-disk"></i> GUARDAR</button>
        <button class="t-btn" onclick="clearLocalLayout()" style="color:red; border:none; margin-left:10px;" title="Reiniciar Mapa"><i class="fa-solid fa-trash"></i></button>
    </div>

    <div id="canvas-area"></div>

    <div id="edit-modal">
        <div class="edit-card">
            <h3 style="margin-top:0">Editar Mesa</h3>
            <div class="edit-form">
                <label>Nombre / N√∫mero:</label>
                <input type="text" id="edit-name">
                
                <div class="edit-row">
                    <div style="flex:1">
                         <label>Forma:</label>
                        <select id="edit-shape">
                            <option value="round">Redonda</option>
                            <option value="square">Cuadrada</option>
                            <option value="rect">Rectangular</option>
                        </select>
                    </div>
                    <div style="flex:1">
                         <label>Capacidad:</label>
                        <input type="number" id="edit-capacity" min="1" max="50">
                    </div>
                </div>

                <div class="edit-row">
                    <div style="flex:1">
                        <label>Ancho (px):</label>
                        <input type="number" id="edit-width" step="10">
                    </div>
                    <div style="flex:1">
                        <label>Alto (px):</label>
                        <input type="number" id="edit-height" step="10">
                    </div>
                </div>
                
                <div class="edit-row">
                     <div style="flex:1">
                        <label>Rotaci√≥n (¬∞):</label>
                        <input type="number" id="edit-rotation" step="15" value="0">
                    </div>
                </div>

            </div>
            <div class="edit-actions">
                <button class="t-btn" style="color:red; border-color:red;" onclick="deleteSelectedTable()">Borrar</button>
                <button class="t-btn" onclick="document.getElementById('edit-modal').style.display='none'">Cancelar</button>
                <button class="t-btn" style="background:var(--novio); color:white; border:none;" onclick="saveTableEdits()">Aplicar</button>
            </div>
        </div>
    </div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxkWDPOJ4q4P81f9DDyVs8cWwV7wEz7_hk9YdNOZvYQYTwtetc-VNtqpqsANmMcbQE/exec"; 
    let guests = [], mapElements = [], isGroupedByFamily = false;
    let editingTableId = null;

    window.onload = async () => {
        // --- SEGURIDAD ---
        // Si no ponen la contrase√±a, borramos todo el cuerpo de la p√°gina
        if(prompt("üîê Contrase√±a de Administrador:") !== "PYJ310524") {  //CONTRASE√ëA
            document.body.innerHTML = "<div style='display:flex;height:100vh;justify-content:center;align-items:center;'><h1>‚õî Acceso Restringido</h1></div>"; 
            return; 
        }
        // -----------------

        loadLocalLayout(); // Cargar croquis guardado en navegador
        try {
            const res = await fetch(`${API_URL}?action=getAllConfirmed`);
            const data = await res.json();
            if(data.status === 'success') { 
                guests = data.guests; 
                syncGuestsWithLayout(); // Sincronizar quienes ya tienen mesa en el mapa
                syncTablesFromExcel();
                renderSidebar(); 
                
                // Si no hay elementos en el mapa local, intentar usar la info de 'mesa' del excel para auto-crearlas
                if(mapElements.length === 0) autoCreateTablesFromExcel();
            }
        } catch(e) { alert("Error cargando datos: " + e); }
    };
    
    // Cargar mapa guardado
    function loadLocalLayout() {
        const saved = localStorage.getItem('pj_floorplan');
        if(saved) {
            mapElements = JSON.parse(saved);
            mapElements.forEach(el => renderElement(el, true)); // true = no agregar al array de nuevo
        }
    }
    
    function autoCreateTablesFromExcel() {
        // Crea mesas basadas en la columna MESA_ASIGNADA si el mapa est√° vac√≠o
        const mesas = [...new Set(guests.map(g => g.mesa).filter(m => m && m !== "Por asignar"))];
        mesas.forEach((m, i) => {
            // Distribuci√≥n en rejilla simple
            const cols = 5;
            const x = 100 + (i % cols) * 180;
            const y = 100 + Math.floor(i / cols) * 180;
            
            const el = {
                id: 'tbl_auto_' + m, type: 'table', subtype: 'round', x: x, y: y, 
                guests: [], name: m, capacity: 10, width: 130, height: 130, rotation: 0
            };
            mapElements.push(el);
            renderElement(el, true);
        });
        
        // Asignar invitados a esas mesas reci√©n creadas
        guests.forEach(g => {
            if(g.mesa && g.mesa !== "Por asignar") {
                const tbl = mapElements.find(t => t.name === g.mesa);
                if(tbl) tbl.guests.push(g);
            }
        });
        // Actualizar visuales
        mapElements.forEach(t => analyzeTableRules(t));
        saveLocalLayout();
    }

    function syncGuestsWithLayout() {
        // Asegurar que los objetos mesa tengan los datos actualizados de los invitados
        mapElements.forEach(t => {
            if(t.type === 'table') {
                // Limpiar guests viejos y volver a llenar con la data fresca del Excel/API
                // Basado en el nombre de la mesa o si guardamos IDs
                // Para este flujo, asumimos que la UI manda, as√≠ que respetamos lo que hay en 'mapElements'
                // PERO actualizamos la info del guest (por si cambi√≥ su status a NO)
                
                // Filtrar guests que ya no est√°n confirmados
                t.guests = t.guests.filter(gLoc => guests.find(gRem => gRem.id === gLoc.id));
                // Actualizar datos de guests existentes
                t.guests = t.guests.map(gLoc => guests.find(gRem => gRem.id === gLoc.id));
                
                analyzeTableRules(t);
            }
        });
    }

    function renderSidebar() {
        const list = document.getElementById('guest-pool');
        list.innerHTML = '';
        let displayGuests = [...guests];
        if(isGroupedByFamily) displayGuests.sort((a, b) => (a.groupId || "").localeCompare(b.groupId || ""));

        displayGuests.forEach(g => {
            // Si ya est√° en una mesa del mapa, no mostrarlo disponible (o mostrarlo deshabilitado)
            const isAssigned = mapElements.some(t => t.type==='table' && t.guests.some(tg => tg.id === g.id));

            let typeClass = 'type-adulto', icons = '';
            const vibra = (g.vibra || "").toUpperCase(), tags = (g.tags || "").toUpperCase();

            if (tags.includes('NI√ëO') || vibra === 'NI√ëOS') typeClass = 'type-nino';
            else if (vibra === 'ADOLESCENTES') typeClass = 'type-adolescente';
            else if (tags.includes('EX') || vibra === 'EX') typeClass = 'type-ex';

            if (tags.includes('NI√ëO')) icons += '<i class="fa-solid fa-baby" title="Ni√±o"></i> ';
            if (tags.includes('EX')) icons += '<i class="fa-solid fa-heart-crack" style="color:brown"></i> ';
            if (tags.includes('VEGANO') || tags.includes('VEGETARIANO')) icons += '<i class="fa-solid fa-leaf" style="color:green"></i> ';
            if (g.movilidad === 'SILLA_RUEDAS') icons += '<i class="fa-solid fa-wheelchair"></i> ';

            const div = document.createElement('div');
            div.className = `guest-chip ${typeClass} draggable-guest`;
            if (isAssigned) div.classList.add('assigned'); // Visualmente desactivado
            
            div.dataset.id = g.id;
            div.innerHTML = `<div><div style="font-weight:600">${g.nombre}</div><span class="family-tag">${g.groupId ? 'Fam. '+g.groupId : 'Indiv.'}</span></div><div class="icon-container">${icons}</div>`;
            list.appendChild(div);
        });
        document.getElementById('stats-display').innerText = `${guests.length} Confirmados`;
    }

    function groupByFamily() { isGroupedByFamily = !isGroupedByFamily; renderSidebar(); }
    function filterGuests() {
        const q = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('.guest-chip').forEach(el => {
            el.style.display = el.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
        });
    }

    function addObj(type, subtype) {
        const id = 'el_' + Date.now();
        // Tama√±os default seg√∫n tipo
        let w=100, h=100;
        if(subtype==='round') { w=130; h=130; }
        if(subtype==='rect') { w=180; h=100; }
        if(subtype==='novios') { w=180; h=60; }
        if(subtype==='dance') { w=250; h=200; }

        const elData = {
            id: id, type: type, subtype: subtype, x: 200, y: 200, guests: [],
            name: type === 'table' ? `Mesa ${countTables()+1}` : subtype.toUpperCase(),
            capacity: 10, width: w, height: h, rotation: 0
        };
        mapElements.push(elData);
        renderElement(elData);
        saveLocalLayout();
    }

    function countTables() { return mapElements.filter(e => e.type === 'table').length; }

    function renderElement(data, isLoading=false) {
        const div = document.createElement('div');
        div.id = data.id;
        div.className = `map-obj shape-${data.subtype} obj-${data.subtype}`;
        if(data.type === 'fixed') div.classList.add('fixed-obj');
        
        // Aplicar estilos guardados
        div.style.width = `${data.width}px`;
        div.style.height = `${data.height}px`;
        div.style.transform = `translate(${data.x}px, ${data.y}px) rotate(${data.rotation||0}deg)`;
        div.dataset.id = data.id;
        
        if (data.type === 'table') {
            div.innerHTML = `
                <div class="table-name" style="transform: rotate(-${data.rotation||0}deg)">${data.name}</div>
                <div class="table-count" style="font-size:1.1rem; color:#666; transform: rotate(-${data.rotation||0}deg)">${data.guests.length}/${data.capacity}</div>
                <div class="table-alert" style="transform: rotate(-${data.rotation||0}deg)">! <div class="alert-tooltip"></div></div>
                <div class="vegan-indicator" style="transform: rotate(-${data.rotation||0}deg)"></div>
            `;
            setupDropzone(div);
        } else {
            let icon = '';
            if(data.subtype==='dj') icon = 'üéµ '; if(data.subtype==='wc') icon = 'üöª ';
            div.innerHTML = `<span style="transform: rotate(-${data.rotation||0}deg)">${icon}${data.name}</span>`;
        }
        setupDraggable(div);
        
        div.addEventListener('dblclick', (e) => {
            e.stopPropagation(); // Evitar triggers indeseados
            if(data.type === 'table') openEditModal(data.id);
            else if(confirm("¬øBorrar elemento?")) deleteObj(data.id);
        });
        document.getElementById('canvas-area').appendChild(div);
        
        if(data.type === 'table' && !isLoading) analyzeTableRules(data);
        if(isLoading && data.type === 'table') setTimeout(()=>analyzeTableRules(data), 100); // Esperar render
    }

    // --- EDICI√ìN ---
    function openEditModal(id) {
        const t = mapElements.find(e => e.id === id);
        if(!t) return;
        editingTableId = id;
        document.getElementById('edit-name').value = t.name;
        document.getElementById('edit-shape').value = t.subtype;
        document.getElementById('edit-capacity').value = t.capacity || 10;
        document.getElementById('edit-width').value = t.width;
        document.getElementById('edit-height').value = t.height;
        document.getElementById('edit-rotation').value = t.rotation || 0;
        document.getElementById('edit-modal').style.display = 'flex';
    }

    function saveTableEdits() {
        const t = mapElements.find(e => e.id === editingTableId);
        if(t) {
            t.name = document.getElementById('edit-name').value;
            t.subtype = document.getElementById('edit-shape').value;
            t.capacity = parseInt(document.getElementById('edit-capacity').value);
            t.width = parseInt(document.getElementById('edit-width').value);
            t.height = parseInt(document.getElementById('edit-height').value);
            t.rotation = parseInt(document.getElementById('edit-rotation').value);
            
            const div = document.getElementById(t.id);
            div.className = `map-obj shape-${t.subtype} obj-${t.subtype}`;
            div.style.width = t.width + 'px';
            div.style.height = t.height + 'px';
            div.style.transform = `translate(${t.x}px, ${t.y}px) rotate(${t.rotation}deg)`;
            
            // Actualizar textos internos para contra-rotar y que se lean bien
            const texts = div.querySelectorAll('.table-name, .table-count, .table-alert, .vegan-indicator, span');
            texts.forEach(el => el.style.transform = `rotate(-${t.rotation}deg)`);

            div.querySelector('.table-name').innerText = t.name;
            analyzeTableRules(t);
            saveLocalLayout();
        }
        document.getElementById('edit-modal').style.display = 'none';
    }

    function deleteSelectedTable() {
        if(confirm("¬øEliminar mesa y liberar invitados?")) deleteObj(editingTableId);
        document.getElementById('edit-modal').style.display = 'none';
    }

    function deleteObj(id) {
        const el = mapElements.find(e => e.id === id);
        if(el && el.type === 'table') {
            el.guests = []; // Vaciar mesa
            renderSidebar(); // Reactivar invitados en sidebar
        }
        mapElements = mapElements.filter(e => e.id !== id);
        document.getElementById(id).remove();
        saveLocalLayout();
    }

    function analyzeTableRules(table) {
        let warnings = [];
        let veganCount = 0;
        const tableDiv = document.getElementById(table.id);
        
        // Update counts
        tableDiv.querySelector('.table-count').innerText = `${table.guests.length}/${table.capacity}`;
        if(table.guests.length >= table.capacity) tableDiv.classList.add('table-full');
        else tableDiv.classList.remove('table-full');

        // Veganos
        table.guests.forEach(g => { if((g.tags||"").includes('VEGAN')) veganCount++; });
        const veganBadge = tableDiv.querySelector('.vegan-indicator');
        veganBadge.style.display = veganCount > 0 ? 'block' : 'none';
        veganBadge.innerText = `ü•ó ${veganCount}`;

        // Reglas
        const hasEx = table.guests.some(g => (g.tags||"").includes('EX'));
        if (hasEx) warnings.push("üíî ALERTA: EX en la mesa.");

        const kids = table.guests.filter(g => (g.tags||"").includes('NI√ëO'));
        kids.forEach(kid => {
            const hasParent = table.guests.some(ad => ad.groupId === kid.groupId && ad.id !== kid.id && !ad.tags.includes('NI√ëO'));
            if (!hasParent) warnings.push(`üö® ALERTA: Ni√±o solo (${kid.nombre.split(' ')[0]})`);
        });

        const hasTeens = table.guests.some(g => (g.vibra||"").toUpperCase() === 'ADOLESCENTES');
        const hasElders = table.guests.some(g => (g.vibra||"").toUpperCase() === 'MAYORES');
        if (hasTeens && hasElders) warnings.push("‚ö†Ô∏è AMBIENTE: Adolescentes y Mayores.");

        // Distancias (Usamos coordenadas guardadas x,y porque getBoundingClientRect var√≠a con scroll/zoom)
        if (hasElders) {
             const noise = mapElements.filter(e => e.subtype === 'dj' || e.subtype === 'dance');
             noise.forEach(obj => {
                const dist = Math.hypot(table.x - obj.x, table.y - obj.y);
                if(dist < 250) warnings.push("üîä RUIDO: Mesa de mayores cerca del DJ.");
             });
        }
        
        const hasWheelchair = table.guests.some(g => g.movilidad === 'SILLA_RUEDAS');
        if (hasWheelchair) {
             const wc = mapElements.find(e => e.subtype === 'wc');
             if(wc) {
                 const dist = Math.hypot(table.x - wc.x, table.y - wc.y);
                 if(dist > 600) warnings.push("‚ôø ACCESIBILIDAD: Lejos de ba√±os.");
             }
        }

        const alertIcon = tableDiv.querySelector('.table-alert');
        const tooltip = tableDiv.querySelector('.alert-tooltip');
        
        if (warnings.length > 0) {
            alertIcon.style.display = 'flex'; tooltip.innerHTML = warnings.join('<br>');
            tableDiv.style.borderColor = warnings.some(w => w.includes('üö®')) ? 'red' : '#ff9800';
        } else {
            alertIcon.style.display = 'none'; tableDiv.style.borderColor = 'white';
        }
    }

    // --- INTERACT ---
    function setupDraggable(el) {
        interact(el).draggable({
            inertia: true,
            modifiers: [ interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true }) ],
            listeners: {
                move(event) {
                    const t = event.target;
                    // Leer estado actual
                    const id = t.dataset.id;
                    const obj = mapElements.find(e => e.id === id);
                    
                    if(obj) {
                        obj.x += event.dx;
                        obj.y += event.dy;
                        t.style.transform = `translate(${obj.x}px, ${obj.y}px) rotate(${obj.rotation||0}deg)`;
                    }
                },
                end(event) { 
                    const obj = mapElements.find(e => e.id === event.target.dataset.id);
                    if(obj && obj.type === 'table') analyzeTableRules(obj);
                    saveLocalLayout();
                }
            }
        });
    }

    function setupDropzone(el) {
        interact(el).dropzone({
            accept: '.draggable-guest', overlap: 0.50,
            ondragenter: (e) => e.target.classList.add('drag-hover'),
            ondragleave: (e) => e.target.classList.remove('drag-hover'),
            ondrop: (e) => {
                assignGuest(e.relatedTarget.dataset.id, e.target.dataset.id);
                e.target.classList.remove('drag-hover');
            }
        });
    }

    interact('.draggable-guest').draggable({
        autoScroll: true,
        listeners: {
            move(event) {
                const t = event.target;
                const x = (parseFloat(t.getAttribute('data-x')) || 0) + event.dx;
                const y = (parseFloat(t.getAttribute('data-y')) || 0) + event.dy;
                t.style.transform = `translate(${x}px, ${y}px)`;
                t.setAttribute('data-x', x); t.setAttribute('data-y', y);
                t.style.zIndex = 9999; t.style.position = 'fixed';
            },
            end(event) {
                event.target.style.transform = 'none';
                event.target.setAttribute('data-x', 0); event.target.setAttribute('data-y', 0);
                event.target.style.position = 'relative'; event.target.style.zIndex = '';
            }
        }
    });

    function assignGuest(guestId, tableId) {
        const table = mapElements.find(e => e.id === tableId);
        const guest = guests.find(g => g.id === guestId);
        
        if(!table || !guest) return;
        if(table.guests.length >= table.capacity) { alert("Mesa llena"); return; }

        // Quitar de otras mesas
        mapElements.forEach(t => {
            if(t.guests) t.guests = t.guests.filter(g => g.id !== guestId);
        });
        
        table.guests.push(guest);
        renderSidebar(); // Para marcarlo como asignado visualmente
        analyzeTableRules(table);
        saveLocalLayout();
    }

    // --- PERSISTENCIA LOCAL Y REMOTA ---
    function saveLocalLayout() {
        localStorage.setItem('pj_floorplan', JSON.stringify(mapElements));
    }
    
    function clearLocalLayout() {
        if(confirm("¬øBorrar todo el dise√±o?")) {
            localStorage.removeItem('pj_floorplan');
            location.reload();
        }
    }

    async function saveData() {
        const btn = document.querySelector('.btn-save'); btn.innerText = "Guardando...";
        const assignments = [];
        mapElements.forEach(t => {
            if(t.guests) t.guests.forEach(g => assignments.push({ id: g.id, mesa: t.name }));
        });
        try {
            await fetch(API_URL, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'text/plain;charset=utf-8'},
                body: JSON.stringify({action: 'SAVE_TABLES', assignments: assignments})
            });
            alert("¬°Distribuci√≥n guardada en Excel!");
            btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> GUARDAR';
        } catch(e) { alert("Error al guardar"); }
    }

    // --- NUEVA FUNCI√ìN: Sincronizar mesas nuevas del Excel ---
    function syncTablesFromExcel() {
        // 1. Obtenemos la lista de mesas que existen en el Excel
        // (Filtramos las que dicen "Por asignar" o est√°n vac√≠as)
        const mesasExcel = [...new Set(guests.map(g => g.mesa).filter(m => m && m !== "Por asignar"))];
        
        // 2. Obtenemos las mesas que YA tienes dibujadas en el mapa
        const mesasMapa = mapElements.filter(e => e.type === 'table').map(e => e.name);

        // 3. Calculamos cu√°les son nuevas (est√°n en Excel pero NO en el mapa)
        const nuevasMesas = mesasExcel.filter(m => !mesasMapa.includes(m));

        // 4. Si hay nuevas, las creamos
        if (nuevasMesas.length > 0) {
            alert(`üì¢ Se encontraron ${nuevasMesas.length} mesas nuevas en el Excel.\nSe a√±adir√°n en la parte superior para que las acomodes.`);
            
            nuevasMesas.forEach((m, i) => {
                // Creamos la mesa visualmente
                const el = {
                    id: 'tbl_sync_' + m + '_' + Date.now(), 
                    type: 'table', subtype: 'round', 
                    x: 100 + (i * 150), y: 50, // Las ponemos en fila arriba
                    guests: [], name: m, capacity: 10, 
                    width: 130, height: 130, rotation: 0
                };
                
                // La guardamos en la memoria del mapa
                mapElements.push(el);
                renderElement(el);
            });
            
            // Guardamos cambios para no perderlas al recargar
            saveLocalLayout();
        }
    }
</script>
</body>
</html>